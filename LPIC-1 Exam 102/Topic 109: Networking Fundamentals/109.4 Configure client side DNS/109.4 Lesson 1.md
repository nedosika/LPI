# 109.4 Урок 1

| **Сертификат:** | LPIC-1                                      |
|:----------------|:--------------------------------------------|
| **Версия:**     | 5.0                                         |
| **Тема:**       | 109 Основы сетевых технологий               |                           
| **Цель:**       | 109.4 Настроить DNS на стороне клиента      |
| **Урок:**       | 1 из 1                                      |


## Введение

В этом уроке рассказывается о настройке преобразования имен на стороне клиента и о том, как использовать несколько CLI инструментов разименования. 

Запоминать и поддерживать IP-адреса, UID, GID и другие числа для всего не достижимого. Службы разименования переводят легко запоминающиеся имена в числовой вид и наоборот. В этом уроке основное внимание уделяется преобразованию имен хостов, но аналогичный процесс возможен и с именами пользователей, именами групп, номерами портов и многими другими сущностями.


## Процесс разименования

Программы, преобразовывающие имена в числа, почти всегда используют функции, предоставляемые стандартной библиотекой C, которой в системах Linux является glibc проекта GNU. В первую очередь эти функции читают файл `/etc/nsswitch.conf` для получения инструкций о том, как разименовать этот тип имени. Этот урок посвящен разименованию хостов, но тот же процесс применим и к другим типам преобразования имен. Когда процесс читает `/etc/nsswitch.conf`, он ищет имя указанным способом. Поскольку `/etc/nsswitch.conf` поддерживает плагины, то, что будет дальше, может быть что угодно. После того, как функция завершит поиск имени или номера, она возвращает результат вызывающему процессу.


## Классы DNS

DNS имеет три класса записей: IN, HS и CH. В этом уроке все DNS-запросы будут иметь тип IN. Класс IN предназначен для интернет-адресов, использующих стек TCP/IP. CH для ChaosNet, сетевой технологии, которая просуществовала недолго и больше не используется. Класс HS предназначен для Hesiod. Hesiod - это способ хранить такие вещи, как passwd и групповые записи в DNS. Гесиод выходит за рамки этого урока.


## Понимание `/etc/nsswitch.conf`

Лучший способ узнать об этом файле - прочитать справочную страницу, которая является частью проекта справочных страниц Linux. Он доступен в большинстве систем. Доступ к нему можно получить с помощью команды `man nsswitch.conf`. Кроме того, его можно найти по адресу https://man7.org/linux/man-pages/dir_section_5.html. 

Ниже приведен простой пример файла `/etc/nsswitch.conf` со страницы руководства:

```console
           passwd:         compat
           group:          compat
           shadow:         compat

           hosts:          dns [!UNAVAIL=return] files
           networks:       nis [NOTFOUND=return] files
           ethers:         nis [NOTFOUND=return] files
           protocols:      nis [NOTFOUND=return] files
           rpc:            nis [NOTFOUND=return] files
           services:       nis [NOTFOUND=return] files
           # This is a comment. It is ignored by the resolution functions.
```

Файл разбит на столбцы. Крайний левый столбец - это тип базы данных имен. Остальные столбцы - это методы, которые функции разрешения должны использовать для поиска имени. За методами следуют функции слева направо. Столбцы с `[]` используются для предоставления некоторой ограниченной условной логики столбцу непосредственно слева от него. 

Предположим, процесс пытается разрешить имя хоста `learning.lpi.org`. Это сделает соответствующий вызов библиотеки C (скорее всего, `gethostbyname`). Затем эта функция прочитает `/etc/nsswitch.conf`. Поскольку процесс ищет имя хоста, он найдет строку, начинающуюся с хостов. Затем он попытается использовать DNS для разрешения имени. Следующий столбец, `[! UNAVAIL=return]` означает, что если служба недоступна, то не пытайтесь использовать следующий источник, то есть, если DNS доступен, прекратите попытки разрешить имя хоста, даже если серверы имен не могут. Если DNS недоступен, перейдите к следующему источнику. В этом случае следующий источник - это `files`. 

Когда вы видите столбец в формате `[result=action]`, это означает, что когда поиск преобразователя столбца слева от него является `result`, тогда выполняется `action`. Если результату предшествует символ `!`, Это означает, что если результат не является результатом, выполните `action`. Описание возможных результатов и действий см. на странице руководства. 

Теперь предположим, что процесс пытается преобразовать номер порта в имя службы. Он прочитал бы строку услуг. Первым перечисленным источником является NIS. NIS - это *сетевая информационная служба* (иногда ее называют желтыми страницами). Это старая служба, которая позволяла централизованно управлять такими вещами, как пользователи. Сейчас он редко используется из-за его слабой безопасности. Следующий столбец `[NOTFOUND=return]` означает, что если поиск был успешным, но служба не была найдена, чтобы прекратить поиск. Если вышеупомянутое условие не применяется, используйте локальные файлы. 

Все, что находится справа от `#`, является комментарием и игнорируется.


## Файл `/etc/resolv.conf`

Файл `/etc/resolv.conf` используется для настройки разрешения хоста через DNS. В некоторых дистрибутивах есть сценарии запуска, демоны и другие инструменты, которые записывают в этот файл. Помните об этом при ручном редактировании этого файла. Если это так, проверьте свой дистрибутив и любую документацию по инструментам конфигурации сети. Некоторые инструменты, такие как Network Manager, оставляют комментарий в файле, сообщая вам, что ручные изменения будут перезаписаны. 

Как и в случае с `/etc/nsswitch.conf`, с файлом связана справочная страница. Доступ к нему можно получить с помощью команды `man resolv.conf` или по адресу https://man7.org/linux/man-pages/man5/resolv.conf.5.html. 

Формат файла довольно прост. В крайнем левом столбце указан параметр `name`. Остальные столбцы в той же строке - значение опции. Самый распространенный вариант - это опция сервера имен. Он используется для указания IPv4- или IPv6-адреса DNS-сервера. На момент написания этой статьи вы можете указать до трех серверов имен. Если ваш `/etc/resolv.conf` не имеет опции `nameserver`, ваша система по умолчанию будет использовать сервер имен на локальном компьютере. 

Ниже приведен простой пример файла, представляющего общие конфигурации:

```console
search lpi.org
nameserver 10.0.0.53
nameserver fd00:ffff::2:53
```

Опция поиска используется для поиска в краткой форме. В этом примере настроен единый поисковый домен `lpi.org`. Это означает, что при любой попытке разрешить имя хоста без доменной части перед поиском будет добавлено `.lpi.org`. Например, если вы попытаетесь найти хост с именем `learning`, резолвер будет искать `learning.lpi.org`. Вы можете настроить до шести поисковых доменов. 

Другой распространенный вариант - это вариант с доменом. Это используется для установки вашего локального доменного имени. Если этот параметр отсутствует, по умолчанию используется все после первой `.` в имени хоста машины. Если имя хоста не содержит `.`, Предполагается, что машина является частью корневого домена. Как и `search`, `domain` можно использовать для поиска по коротким именам. 

Помните, что `domain` и `search` исключают друг друга. Если присутствуют оба, используется последний экземпляр в файле. 

Есть несколько параметров, которые можно настроить, чтобы повлиять на поведение резолвера. Чтобы установить их, используйте ключевое слово `options`, за которым следует имя параметра, который нужно установить, и, если применимо, `:`, за которым следует значение. Ниже приведен пример установки параметра тайм-аута, который представляет собой промежуток времени в секундах, в течение которого преобразователь будет ждать сервера имен перед тем, как отказаться:

```console
option timeout:3
```

Есть и другие варианты файла `resolve.conf`, но они наиболее распространены.


## Файл `/etc/hosts`

Файл `/etc/hosts` используется для преобразования имен в IP-адреса и наоборот. Поддерживаются как IPv4, так и IPv6. Левый столбец - это IP-адрес, остальные - имена, связанные с этим адресом. Чаще всего `/etc/hosts` используется для хостов и адресов, для которых использование DNS невозможно, например, для адресов обратной связи. В приведенном ниже примере определены IP-адреса критически важных компонентов инфраструктуры. 

Вот реалистичный пример файла `/etc/hosts`:

```console
127.0.0.1       localhost
127.0.1.1       proxy
::1             localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters

10.0.0.1        gateway.lpi.org gateway gw
fd00:ffff::1    gateway.lpi.org gateway gw

10.0.1.53       dns1.lpi.org
fd00:ffff::1:53 dns1.lpi.org
10.0.2.53       dns2.lpi.org
fd00:ffff::2:53 dns2.lpi.org
```


## systemd-resolved

Systemd предоставляет службу под названием `systemd-resolved`. Он предоставляет mDNS, DNS и LLMNR. Когда он запущен, он прослушивает DNS-запросы на `127.0.0.53`. Он не предоставляет полноценный DNS-сервер. Любые запросы DNS, которые он получает, просматриваются с помощью запросов к серверам, настроенным в `/etc/systemd/resolv.conf` или `/etc/resolv.conf`. Если вы хотите использовать это, используйте разрешение для хостов в `/etc/nsswitch.conf`. Имейте в виду, что пакет ОС, в котором есть библиотека systemd-resolved, может не быть установлен по умолчанию.


## Инструменты разрешения имен

Пользователям Linux доступно множество инструментов для разрешения имен. Этот урок охватывает три. Один, `getent`, полезен для просмотра того, как будут разрешаться запросы реального мира. Другая команда - `host`, полезная для простых DNS-запросов. Программа под названием `dig` полезна для сложных операций DNS, которые могут помочь в устранении неполадок DNS-сервера.


## Команда `getent`

Утилита `getent` используется для отображения записей из баз данных службы имен. Он может получать записи из любого источника, настраиваемого с помощью `/etc/nsswitch.conf`. 

Чтобы использовать `getent`, выполните команду с типом имени, которое вы хотите разрешить, и, при необходимости, конкретной записью для поиска. Если вы укажете только тип имени, `getent` попытается отобразить все записи этого типа данных:

```console
$ getent hosts
127.0.0.1       localhost
127.0.1.1       proxy
10.0.1.53       dns1.lpi.org
10.0.2.53       dns2.lpi.org
127.0.0.1       localhost ip6-localhost ip6-loopback
$ getent hosts dns1.lpi,org
fd00:ffff::1:53 dns1.lpi.org
```

Начиная с glibc версии 2.2.5, вы можете заставить `getent` использовать определенный источник данных с опцией `-s`. Пример ниже демонстрирует это:

```console
$ getent -s files hosts learning.lpi.org
::1             learning.lpi.org
$ getent -s dns hosts learning.lpi.org
208.94.166.198  learning.lpi.org
```

## Команда хоста

`host` - это простая программа для поиска записей DNS. Без параметров, если `host` присвоено имя, он возвращает наборы записей A, AAAA и MX. Если указан адрес IPv4 или IPv6, он выводит запись PTR, если она доступна:

```console
$ host wikipedia.org
wikipedia.org has address 208.80.154.224
wikipedia.org has IPv6 address 2620:0:861:ed1a::1
wikipedia.org mail is handled by 10 mx1001.wikimedia.org.
wikipedia.org mail is handled by 50 mx2001.wikimedia.org.
$ host 208.80.154.224
224.154.80.208.in-addr.arpa domain name pointer text-lb.eqiad.wikimedia.org.
```

Если вы ищете конкретный тип записи, вы можете использовать `host -t`:

```console
$ host -t NS lpi.org
lpi.org name server dns1.easydns.com.
lpi.org name server dns3.easydns.ca.
lpi.org name server dns2.easydns.net.
$ host -t SOA lpi.org
lpi.org has SOA record dns1.easydns.com. zone.easydns.com. 1593109612 3600 600 1209600 300
```

`host` также можно использовать для запроса определенного сервера имен, если вы не хотите использовать серверы из `/etc/resolve.conf`. Просто добавьте IP-адрес или имя хоста сервера, который вы хотите использовать в качестве последнего аргумента:

```console
$ host -t MX lpi.org dns1.easydns.com
Using domain server:
Name: dns1.easydns.com
Address: 64.68.192.10#53
Aliases:

lpi.org mail is handled by 10 aspmx4.googlemail.com.
lpi.org mail is handled by 10 aspmx2.googlemail.com.
lpi.org mail is handled by 5 alt1.aspmx.l.google.com.
lpi.org mail is handled by 0 aspmx.l.google.com.
lpi.org mail is handled by 10 aspmx5.googlemail.com.
lpi.org mail is handled by 10 aspmx3.googlemail.com.
lpi.org mail is handled by 5 alt2.aspmx.l.google.com.
```


## Команда `dig`

Еще один инструмент для запроса DNS-серверов - это `dig`. Эта команда более подробна, чем `host`. По умолчанию поисковые запросы для записей A. Вероятно, это слишком многословно для простого поиска IP-адреса или имени хоста. `dig` будет работать для простых поисков, но он больше подходит для устранения неполадок конфигурации DNS-сервера:

```console
$ dig learning.lpi.org

; <<>> DiG 9.11.5-P4-5.1+deb10u1-Debian <<>> learning.lpi.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 63004
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 3, ADDITIONAL: 5

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: ca7a415be1cec45592b082665ef87f3483b81ddd61063c30 (good)
;; QUESTION SECTION:
;learning.lpi.org.		IN	A

;; ANSWER SECTION:
learning.lpi.org.	600	IN	A	208.94.166.198

;; AUTHORITY SECTION:
lpi.org.		86400	IN	NS	dns2.easydns.net.
lpi.org.		86400	IN	NS	dns1.easydns.com.
lpi.org.		86400	IN	NS	dns3.easydns.ca.

;; ADDITIONAL SECTION:
dns1.easydns.com.	172682	IN	A	64.68.192.10
dns2.easydns.net.	170226	IN	A	198.41.222.254
dns1.easydns.com.	172682	IN	AAAA	2400:cb00:2049:1::a29f:1835
dns2.easydns.net.	170226	IN	AAAA	2400:cb00:2049:1::c629:defe

;; Query time: 135 msec
;; SERVER: 192.168.1.20#53(192.168.1.20)
;; WHEN: Sun Jun 28 07:29:56 EDT 2020
;; MSG SIZE  rcvd: 266
```

Как видите, `dig` предоставляет много информации. Вывод разделен на разделы. В первом разделе отображается информация об установленной версии `dig` и отправленном запросе, а также любые параметры, используемые для команды. 

Далее отображается информация о запросе и ответе. В следующем разделе представлена информация об используемых расширениях EDNS и запросе. В примере используется расширение cookie. `dig` ищет A-запись для `learning.lpi.org`. 

В следующем разделе показан результат запроса. Число во втором столбце - это TTL ресурса в секундах. 

Остальные выходные данные содержат информацию о серверах имен домена, включая записи NS для сервера, а также записи A и AAAA серверов в записи NS домена. 

Как и `host`, вы можете указать тип записи с помощью опции `-t`:

```console
$ dig -t SOA lpi.org

; <<>> DiG 9.11.5-P4-5.1+deb10u1-Debian <<>> -t SOA lpi.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 16695
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 3, ADDITIONAL: 6

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 185c67140a63baf46c4493215ef8906f7bfbe15bdca3b01a (good)
;; QUESTION SECTION:
;lpi.org.			IN	SOA

;; ANSWER SECTION:
lpi.org.		600	IN	SOA	dns1.easydns.com. zone.easydns.com. 1593109612 3600 600 1209600 300

;; AUTHORITY SECTION:
lpi.org.		81989	IN	NS	dns1.easydns.com.
lpi.org.		81989	IN	NS	dns2.easydns.net.
lpi.org.		81989	IN	NS	dns3.easydns.ca.

;; ADDITIONAL SECTION:
dns1.easydns.com.	168271	IN	A	64.68.192.10
dns2.easydns.net.	165815	IN	A	198.41.222.254
dns3.easydns.ca.	107	IN	A	64.68.196.10
dns1.easydns.com.	168271	IN	AAAA	2400:cb00:2049:1::a29f:1835
dns2.easydns.net.	165815	IN	AAAA	2400:cb00:2049:1::c629:defe

;; Query time: 94 msec
;; SERVER: 192.168.1.20#53(192.168.1.20)
;; WHEN: Sun Jun 28 08:43:27 EDT 2020
;; MSG SIZE  rcvd: 298
```

Dig имеет множество опций для точной настройки как вывода, так и запроса, отправляемого на сервер. Эти параметры начинаются с `+`. Один из вариантов - это `short` вариант, который подавляет весь вывод, кроме результата:

```console
$ dig +short lpi.org
65.39.134.165
$ dig +short -t SOA lpi.org
dns1.easydns.com. zone.easydns.com. 1593109612 3600 600 1209600 300
```

Вот пример отключения расширения EDNS для файлов cookie:

```console
$ dig +nocookie -t MX lpi.org

; <<>> DiG 9.11.5-P4-5.1+deb10u1-Debian <<>> +nocookie -t MX lpi.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 47774
;; flags: qr rd ra; QUERY: 1, ANSWER: 7, AUTHORITY: 3, ADDITIONAL: 5

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;lpi.org.			IN	MX

;; ANSWER SECTION:
lpi.org.		468	IN	MX	0 aspmx.l.google.com.
lpi.org.		468	IN	MX	10 aspmx4.googlemail.com.
lpi.org.		468	IN	MX	10 aspmx5.googlemail.com.
lpi.org.		468	IN	MX	10 aspmx2.googlemail.com.
lpi.org.		468	IN	MX	10 aspmx3.googlemail.com.
lpi.org.		468	IN	MX	5 alt2.aspmx.l.google.com.
lpi.org.		468	IN	MX	5 alt1.aspmx.l.google.com.

;; AUTHORITY SECTION:
lpi.org.		77130	IN	NS	dns2.easydns.net.
lpi.org.		77130	IN	NS	dns3.easydns.ca.
lpi.org.		77130	IN	NS	dns1.easydns.com.

;; ADDITIONAL SECTION:
dns1.easydns.com.	76140	IN	A	64.68.192.10
dns2.easydns.net.	73684	IN	A	198.41.222.254
dns1.easydns.com.	76140	IN	AAAA	2400:cb00:2049:1::a29f:1835
dns2.easydns.net.	73684	IN	AAAA	2400:cb00:2049:1::c629:defe

;; Query time: 2 msec
;; SERVER: 192.168.1.20#53(192.168.1.20)
;; WHEN: Mon Jun 29 10:18:58 EDT 2020
;; MSG SIZE  rcvd: 389
```

## Упражнения для закрепления

1. Что будет делать команда ниже?
```console
getent group openldap
```
2. В чем самое большое различие между `getent` и другими инструментами `host` и `dig`? 
3. Какой параметр `dig` и `host` используется для указания типа записи, которую вы хотите получить? 
4. Что из следующего является правильной записью в `/etc/hosts`?                        
| `::1 localhost`       |      |
| `localhost 127.0.0.1` |      |
5. Какой параметр `getent` используется, чтобы указать, какой источник данных следует использовать для поиска?


## Упражнения на размышление

1. Что, вероятно, произойдет, если вы отредактируете файл `/etc/resolv.conf` ниже с помощью текстового редактора?
```console
# Generated by NetworkManager
nameserver 192.168.1.20
```
| Изменения будут перезаписаны NetworkManager. |   |
| NetworkManager обновит свою конфигурацию с вашими изменениями. |   |                           
| Ваши изменения не повлияют на систему. |   |
| NetworkManager будет отключен. |   |

2. Что означает следующая строка в `/etc/nsswitch.conf`:
```console
hosts: files [SUCCESS=continue] dns
```
3. Учитывая следующий `/etc/resolv.conf`, почему система не разрешает имена через DNS?
```console
search lpi.org
#nameserver fd00:ffff::1:53
#nameserver 10.0.1.53
```
4. Что делает команда `dig +noall +answer +question lpi.org`?
5. Как вы можете изменить значения по умолчанию для `dig`, не указывая их в командной строке?


## Резюме

Команда `getent` - отличный инструмент для просмотра результатов вызовов преобразователя. Для простых DNS-запросов `host` прост в использовании и производит простой вывод. Если вам нужна подробная информация или требуется точная настройка DNS-запроса, вам, скорее всего, будет лучше всего `dig`. 

Благодаря возможности добавлять плагины разделяемых библиотек и настраивать поведение преобразователя, Linux имеет отличную поддержку для разрешения имен и номеров различных типов. Программа `getent` может использоваться для разрешения имен с помощью библиотек преобразователя. `host` и `dig` могут использоваться для запроса DNS-серверов. 

Файл `/etc/nsswitch.conf` используется для настройки поведения распознавателя. Вы можете изменять источники данных и добавлять простую условную логику для типов имен с несколькими источниками. 

DNS настраивается путем редактирования `/etc/resolv.conf`. Во многих дистрибутивах есть инструменты, которые управляют этим файлом за вас, поэтому обязательно проверьте документацию по вашей системе, если ручные изменения не сохраняются. 

Файл `/etc/hosts` используется для преобразования имен хостов в IP-адреса и наоборот. Обычно он используется для определения имен, таких как `localhost`, которые недоступны через DNS. 

В файлах конфигурации, рассматриваемых в этом уроке, можно оставлять комментарии. Любой текст справа от `#` игнорируется системой.


## Ответы на упражнения для закрепления

**1. Что будет делать команда ниже?**
```console
getent group openldap
```
Она прочитает `/etc/nsswitch.conf`, найдет группу `openldap` из перечисленных источников и отобразит информацию о ней, если она будет найдена.

**2. В чем самое большое различие между `getent` и другими инструментами `host` и `dig`?**  
`getent` ищет имена с помощью библиотек преобразователя, остальные просто запрашивают DNS. `getent` можно использовать для устранения неполадок вашего `/etc/nsswitch.conf` и конфигурации библиотек разрешения имен, на использование которых настроена ваша система. `host` и `dig` используются для поиска записей DNS.

**3. Какой параметр `dig` и `host` используется для указания типа записи, которую вы хотите получить?**  
Обе программы используют `-t` для указания типа записи, которую вы хотите найти.

**4. Что из следующего является правильной записью в `/etc/hosts`?**                          
| `::1 localhost`           |  X  |
| **`localhost 127.0.0.1`** |     |
`::1 localhost` - правильная строка. В левом столбце всегда указывается адрес IPv4 или IPv6.

**5. Какой параметр `getent` используется, чтобы указать, какой источник данных следует использовать для поиска?**  
Параметр `-s` используется для указания источника данных. Например:
```console
$ getent -s files hosts learning.lpi.org
192.168.10.25   learning.lpi.org
$ getent -s dns hosts learning.lpi.org
208.94.166.198  learning.lpi.org
```

## Ответы на упражнения для размышления

**1. Что, вероятно, произойдет, если вы отредактируете файл `/etc/resolv.conf` ниже с помощью текстового редактора?**  
```console
# Generated by NetworkManager
nameserver 192.168.1.20
```

|:-|-|
| Изменения будут перезаписаны NetworkManager. | X |
| NetworkManager обновит свою конфигурацию с вашими изменениями. |   |                           
| Ваши изменения не повлияют на систему. |   |
| NetworkManager будет отключен. |   |


**2. Что означает следующая строка в `/etc/nsswitch.conf`:**  
```console
hosts: files [SUCCESS=continue] dns
```
Поиск имен хостов сначала проверяет ваши файлы `/etc/hosts`, а затем DNS. Если найденная запись найдена в файлах и DNS, будет использоваться запись в DNS.

**3. Учитывая следующий `/etc/resolv.conf`, почему система не разрешает имена через DNS?**  
```console
search lpi.org
#nameserver fd00:ffff::1:53
#nameserver 10.0.1.53
```
Оба DNS-сервера закомментированы, и на локальном хосте нет DNS-сервера.

**4. Что делает команда `dig +noall +answer +question lpi.org`?**  
Она ищет запись `A` для `lpi.org` и отображает только запрос и ответ.

**5. Как вы можете изменить значения по умолчанию для `dig`, не указывая их в командной строке?**  
Вы создаете файл `.digrc` в своем домашнем каталоге.
