# 105.1 Урок 1

| **Сертификат:** | LPIC-1                                      |
|:----------------|:--------------------------------------------|
| **Версия:**     | 5.0                                         |
| **Тема:**       | 105 Оболочки и сценарии оболочки            |                           
| **Цель:**       | 105.1 Основы интернет-протоколов            |
| **Урок:**       | 1 из 3                                      |


## Введение

Оболочка, возможно, является самым мощным инструментом в системе Linux и может быть определена как интерфейс между пользователем и ядром операционной системы. Она интерпретирует команды, введенные пользователем. Следовательно, все системные администраторы должны иметь опыт работы с оболочкой. Как мы уже наверняка знаем, Bourne Again Shell (*Bash*) *де-факто* является оболочкой для подавляющего большинства дистрибутивов Linux. 

После запуска первое, что делает Bash - или любая другая оболочка, если на то пошло - выполняет серию сценариев запуска. Эти сценарии настраивают среду сеанса. Существуют как общесистемные, так и пользовательские скрипты. Мы можем поместить в эти сценарии свои личные предпочтения или настройки, которые лучше всего соответствуют потребностям наших пользователей, в форме переменных, псевдонимов и функций. 

Точная серия файлов запуска зависит от очень важного параметра: типа оболочки. Давайте посмотрим на разнообразие существующих оболочек.


## Типы оболочки: интерактивная против неинтерактивной и Login против Non-Login входа в систему

Для начала давайте проясним концепции *интерактивности* и *входа* в систему в контексте оболочек: 

Интерактивные/неинтерактивные оболочки  
Этот вид оболочки относится к взаимодействию, которое происходит между пользователем и оболочкой: пользователь обеспечивает ввод, вводя команды в терминал с помощью клавиатуры; оболочка обеспечивает вывод, выводя сообщения на экран. 

Login/Non-login оболочки  
Этот вид оболочки относится к событию, когда пользователь обращается к компьютерной системе, предоставляя свои учетные данные, такие как имя пользователя и пароль. 

Как интерактивные, так и неинтерактивные оболочки могут быть как для входа, так и без входа, и любая возможная комбинация этих типов имеет свое конкретное применение. 

*Интерактивные оболочки входа в систему* выполняются, когда пользователи входят в систему, и используются для настройки конфигураций пользователей в соответствии с их потребностями. Хорошим примером этого типа оболочки может быть группа пользователей, принадлежащих к одному отделу, которым требуется конкретная переменная, установленная в их сеансах. 

Под *интерактивными оболочками без входа в систему* мы понимаем любые другие оболочки, открытые пользователем после входа в систему. Пользователи используют эти оболочки во время сеансов для выполнения задач обслуживания и администрирования, таких как установка переменных, времени, копирование файлов, написание сценариев и т. д. 

С другой стороны, *неинтерактивные оболочки* не требуют какого-либо взаимодействия с человеком. Таким образом, эти оболочки не запрашивают у пользователя ввод, а их вывод, если таковой имеется, в большинстве случаев записывается в журнал. 

*Неинтерактивные оболочки входа в систему* довольно редки и непрактичны. Их использование практически не существует, и мы будем комментировать их только для понимания поведения оболочки. Некоторые странные примеры включают принудительный запуск сценария из оболочки входа с помощью `/bin/bash --login <some_script>` или передачу стандартного вывода (*stdout*) команды на стандартный ввод (*stdin*`) ssh-соединения:

```console
<some_command> | ssh <some_user>@<some_server>
```

Что *касается неинтерактивной оболочки без входа в систему*, то здесь нет ни взаимодействия, ни входа в систему от имени пользователя, поэтому здесь мы имеем в виду использование автоматизированных сценариев. Эти скрипты в основном используются для выполнения повторяющихся задач администрирования и обслуживания, например, тех, которые включены в cronjobs. В таких случаях `bash` не читает файлы запуска.


### Открытие терминала

Когда мы находимся в среде рабочего стола, мы можем либо открыть приложение терминала, либо переключиться на одну из системных консолей. Следовательно, новая оболочка является либо оболочкой `pts` при открытии из эмулятора терминала в графическом интерфейсе пользователя, либо оболочкой `tty` при запуске из системной консоли. В первом случае мы имеем дело не с терминалом, а с эмулятором терминала. В рамках графических сеансов эмуляторы терминалов, такие как *gnome-terminal* или *konsole*, очень многофункциональны и удобны для пользователя по сравнению с терминалами с текстовым интерфейсом пользователя. Менее функциональные эмуляторы терминала включают, среди прочего, *XTerm* и *sakura*. 

Используя комбинации <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>F1</kbd>-<kbd>F6</kbd>, мы можем перейти к входам в консоль, которые открывают интерактивную текстовую оболочку входа. <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>F7</kbd> вернет сеанс обратно на рабочий стол.

>`tty` - телетайп; `pts` обозначает псевдотерминальное ведомое устройство. Для получения дополнительной информации: `man tty` и `man pts`


### Запуск оболочек с помощью `bash`

После входа в систему введите `bash` в терминал, чтобы открыть новую оболочку. Технически эта оболочка является дочерним процессом текущей оболочки. 

При запуске дочернего процесса `bash` мы можем указать различные переключатели, чтобы определить, какую оболочку мы хотим запустить. Вот некоторые важные параметры вызова `bash`: 

`bash -l` или `bash --login`  
вызовет оболочку входа в систему. 

`bash -i`  
вызовет интерактивную оболочку. 

`bash --noprofile`  
с оболочками входа в систему будут игнорировать как общесистемный файл запуска `/etc/profile`, так и файлы запуска уровня пользователя `~/.bash_profile`, `~/.bash_login` и `~/.profile`

`.bash --norc`  
с интерактивными оболочками игнорирует как общесистемный файл запуска `/etc/bash.bashrc`, так и файл запуска уровня пользователя `~/.bashrc`. 

`bash --rcfile <file>`  
с интерактивными оболочками будет использовать `<file>` в качестве файла запуска, игнорируя общесистемный `/etc/bash.bashrc` и пользовательский уровень `~/.bashrc`. 

Ниже мы обсудим различные файлы запуска.


### Запуск оболочек с помощью `su` и `sudo`

Используя эти две похожие программы, мы можем получить определенные типы оболочек: 

`su`  
Изменяет ID пользователя или становится суперпользователем (`root`). С помощью этой команды мы можем вызывать как оболочки с входом, так и оболочки без входа: 
* `su - user2`, `su -l user2` или `su --login user2` запустят интерактивную оболочку входа в систему как `user2`. * `su user2` запустит интерактивную оболочку без входа в систему как `user2`. 
* `su - root` или `su` - запустит интерактивную оболочку входа в систему как `root`. 
* `su root` или `su` запустит интерактивную оболочку без входа в систему от имени пользователя `root`. 

`sudo`  
Выполнять команды от имени другого пользователя(включая суперпользователя). Поскольку эта команда в основном используется для временного получения привилегий `root`, пользователь, использующий ее, должен находиться в файле `sudoers`. Чтобы добавить пользователей в `sudoers`, нам нужно стать `root`, а затем запустить:

```console
root@debian:~# usermod -aG sudo user2
```

Так же, как `su`, `sudo` позволяет нам вызывать как оболочки входа, так и оболочки без входа: 
* `sudo su - user2`, `sudo su -l user2` или `sudo su --login user2` запустит интерактивную оболочку входа в систему как `user2`. 
* `sudo su user2` запустит интерактивную оболочку без входа в систему как `user2`. 
* `sudo -u user2 -s` запустит интерактивную оболочку без входа в систему как `user2`. 
* `sudo su - root` или `sudo su` - запустит интерактивную оболочку входа в систему с правами `root`. 
* `sudo -i` запустит интерактивную оболочку входа в систему с правами `root`. 
* `sudo -i <some_command>` запустит интерактивную оболочку входа в систему от имени пользователя `root`, выполнит команду и вернется к исходному пользователю. 
* `sudo su root` или `sudo su` запустит интерактивную оболочку без входа в систему с правами `root`. 
* `sudo -s` или `sudo -u root -s` запустит оболочку без входа в систему с правами `root`. 

При использовании `su` или `sudo` важно учитывать наш конкретный сценарий запуска новой оболочки: нужна ли нам среда целевого пользователя или нет? Если это так, мы бы использовали параметры, которые вызывают оболочки входа в систему; если нет, то те, которые вызывают оболочки без входа в систему.


### Какой у нас тип оболочки?

Чтобы узнать, с какой оболочкой мы работаем, мы можем ввести в терминал `echo $0` и получить следующий вывод: 

Интерактивный вход  
`-bash` или `-su` 

Интерактивный без входа в систему  
`bash` или `/bin/bash` 

Неинтерактивный без входа в систему (скрипты)  
`<name_of_script>`


### Сколько у нас оболочек?

Чтобы узнать, сколько оболочек `bash` запущено в системе, мы можем использовать команду `ps aux | grep bash`:

```console
user2@debian:~$ ps aux | grep bash
user2       5270  0.1  0.1  25532  5664 pts/0    Ss   23:03   0:00 bash
user2       5411  0.3  0.1  25608  5268 tty1     S+   23:03   0:00 -bash
user2       5452  0.0  0.0  16760   940 pts/0    S+   23:04   0:00 grep --color=auto bash
```

`user2` в debian вошел в сеанс GUI (или X Window System) и открыл `gnome-terminal`, затем нажал <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>F1</kbd>, чтобы войти в сеанс терминала `tty`. Наконец, он вернулся к сеансу графического интерфейса пользователя, нажав <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>F7</kbd> и набрав команду `ps aux | grep bash`. Таким образом, вывод показывает интерактивную оболочку без входа через эмулятор терминала (`pts/0`) и интерактивную оболочку входа через соответствующий текстовый терминал (`tty1`). Также обратите внимание, что последнее поле каждой строки (команды) - это `bash` для первой и `-bash` для последней.


### Откуда оболочки получают свою конфигурацию: файлы запуска

Что ж, теперь, когда мы знаем типы оболочки, которые мы можем найти в системе Linux, самое время посмотреть, какие файлы запуска выполняются какой оболочкой. Обратите внимание, что общесистемные или глобальные сценарии помещаются в каталог `/etc/`, тогда как локальные или пользовательские сценарии находятся в домашней папке пользователя (`~`). Кроме того, при поиске более одного файла, как только один найден и запущен, остальные игнорируются. Исследуйте и изучайте эти файлы самостоятельно в своем любимом текстовом редакторе или набрав `less <startup_file>`.

>Файлы запуска можно разделить на специфические для Bash(ограниченные только конфигурациями и командами `bash`) и общие(относящиеся к большинству оболочек).


#### Интерактивная оболочка входа

##### Глобальный уровень

`/etc/profile`  
Это общесистемный файл `.profile` для оболочки Bourne и совместимых с Bourne оболочек (включая `bash`). Посредством серии операторов `if` этот файл устанавливает ряд переменных, таких как `PATH` и `PS1` соответственно, а также источник - если они существуют - как файл `/etc/bash.bashrc`, так и те, что находятся в каталоге `/etc/profile.d`. 

`/etc/profile.d/*`  
Этот каталог может содержать сценарии, которые запускаются `/etc/profile`.


##### Локальный уровень

`~/.bash_profile`  
Этот специальный файл Bash используется для настройки пользовательской среды. Его также можно использовать как источник `~/.bash_login` и `~/.profile`. 

`~/.bash_login`  
Также специфичен для Bash, этот файл будет выполняться только в том случае, если нет файла `~/.bash_profile`. Его название предполагает, что его следует использовать для выполнения команд, необходимых при входе в систему. 

`~/.profile`  
Этот файл не является специфичным для Bash и будет получен только в том случае, если не существует ни `~/.bash_profile`, ни `~/.bash_login`, что обычно имеет место. Таким образом, основная цель `~/.profile` - это проверка того, запущена ли оболочка Bash и - если да - поиск `~/.bashrc`, если он существует. Обычно он устанавливает переменную `PATH` так, чтобы она включала личный каталог пользователя `~/bin`, если он существует. 

`~/.bash_logout`  
Если он существует, этот специальный файл Bash выполняет некоторые операции очистки при выходе из оболочки. Это может быть удобно в таких случаях, как удаленные сеансы.

##### Изучение файлов конфигурации интерактивной оболочки входа

