# 110.2 Урок 1

| **Сертификат:** | LPIC-1                                      |
|:----------------|:--------------------------------------------|
| **Версия:**     | 5.0                                         |
| **Тема:**       | 110 Безопасность                            |                           
| **Цель:**       | 110.3 Настройка безопасности хоста    |
| **Урок:**       | 1 из 1                                      |


## Введение

В этой главе объясняются четыре основных способа повышения безопасности хоста: 
1. Некоторые основные команды и параметры конфигурации для повышения безопасности аутентификации с использованием теневых паролей. 
2. Как использовать супердемоны для прослушивания входящих сетевых подключений. 
3. Проверка сетевых сервисов на наличие лишних демонов. 
4. Обертки TCP как своего рода простой брандмауэр.


## Повышение безопасности аутентификации с помощью теневых паролей

Основные компоненты данных учетной записи пользователя хранятся в файле `/etc/passwd`. Этот файл содержит семь полей: имя пользователя, идентификатор пользователя, идентификатор группы, пароль, комментарий (также известный как GECOS), расположение домашнего каталога и, наконец, оболочка по умолчанию. Простой способ запомнить порядок этих полей - подумать о процессе входа пользователя в систему: сначала вы вводите имя для входа, во-вторых, система сопоставляет его с идентификатором пользователя (uid) и, в-третьих, с идентификатором группы (gid). Четвертый шаг запрашивает пароль, пятый ищет комментарий, шестой входит в домашний каталог пользователя, а седьмой шаг устанавливает оболочку по умолчанию. 

Хотя в современных системах пароль больше не хранится в файле `/etc/passwd`. Вместо этого поле пароля содержит только символ `x` в нижнем регистре. Файл `/etc/passwd` должен быть доступен для чтения всем пользователям. Поэтому хранить там пароли - не лучшая идея. Символ `x` указывает, что зашифрованный (хешированный) пароль фактически хранится в файле `/etc/shadow`. Этот файл не должен быть доступен для чтения всем пользователям. 

Параметры пароля настраиваются с помощью команд `passwd` и `chage`. Обе команды изменят запись для пользователя `emma` в файле `/etc/shadow`. Как суперпользователь вы можете установить пароль для пользователя `emma` с помощью следующей команды:

```console
$ sudo passwd emma
New password:
Retype new password:
passwd: password updated successfully
```

Затем вам будет дважды предложено подтвердить новый пароль. 

Чтобы перечислить время истечения срока действия пароля и другие параметры истечения срока действия пароля для пользователя `emma`:

```console
$ sudo chage -l emma
Last password change					: Apr 27, 2020
Password expires					: never
Password inactive					: never
Account expires						: never
Minimum number of days between password change		: 0
Maximum number of days between password change		: 99999
Number of days of warning before password expires	: 7
```

Чтобы предотвратить вход пользователя `emma` в систему, суперпользователь может установить дату истечения срока действия пароля, предшествующую текущей дате. Например, если сегодняшняя дата - 27 марта 2020 г., вы можете истечь срок действия пароля пользователя, указав более старую дату:

```console
$ sudo chage -E 2020-03-28 emma
```

В качестве альтернативы суперпользователь может использовать:

```console
$ sudo passwd -l emma
```

для временной блокировки учетной записи с помощью параметра `-l` для `passwd`. Чтобы проверить влияние этих изменений, попробуйте войти в систему под учетной записью `emma`:

```console
$ sudo login emma
Password:
Your account has expired; please contact your system administrator

Authentication failure
```

Чтобы запретить всем пользователям, кроме пользователя `root`, временно войти в систему, суперпользователь может создать файл с именем `/etc/nologin`. Этот файл может содержать сообщение для пользователей, уведомляющее их о том, почему они не могут войти в систему (например, уведомления о техническом обслуживании системы). Подробнее см. `man 5 nologin`. Обратите внимание, что есть также команда `nologin`, которую можно использовать для предотвращения входа в систему, если она установлена в качестве оболочки по умолчанию для пользователя. Например:

```console
$ sudo usermod -s /sbin/nologin emma
```

Подробнее см. `man 8 nologin`.


## Как использовать Superdaemon для прослушивания входящих сетевых подключений

Сетевые службы, такие как веб-серверы, почтовые серверы и серверы печати, обычно работают как автономная служба, прослушивающая выделенный сетевой порт. Все эти автономные службы работают параллельно. В классической системе на основе Sys-V-init каждой из этих служб можно управлять с помощью команд `service`. В текущих системах на основе systemd вы должны использовать `systemctl` для управления службой. 

В прежние времена наличие компьютерных ресурсов было намного меньше. Запускать многие службы в автономном режиме в тандеме было не лучшим вариантом. Вместо этого использовался так называемый супердемон, который прослушивал входящие сетевые соединения и запускал соответствующую службу по запросу. Этот метод построения сетевого подключения занял немного больше времени. Хорошо известными супердемонами являются `inetd` и `xinetd`. В современных системах, основанных на `systemd`, аналогичным образом можно использовать модуль `systemd.socket`. В этом разделе мы будем использовать `xinetd` для перехвата подключений к демону `sshd` и запускать этот демон по запросу, чтобы продемонстрировать, как использовался супердемон. 

Перед настройкой службы `xinetd` необходима некоторая подготовка. Неважно, используете ли вы систему на основе Debian или Red Hat. Хотя эти объяснения были протестированы с Debian/GNU Linux 9.9, они должны работать в любой текущей системе Linux с `systemd` без каких-либо существенных изменений. Сначала убедитесь, что установлены пакеты `openssh-server` и `xinetd`. Теперь убедитесь, что служба SSH работает с:

```console
$ systemctl status sshd
● ssh.service - OpenBSD Secure Shell server
   Loaded: loaded (/lib/systemd/system/ssh.service; enabled; vendor preset: enabled)
   Active: active (running) since Mon 2020-04-27 09:33:48 EDT; 3h 11min ago
     Docs: man:sshd(8)
           man:sshd_config(5)
  Process: 430 ExecStartPre=/usr/sbin/sshd -t (code=exited, status=0/SUCCESS)
 Main PID: 460 (sshd)
    Tasks: 1 (limit: 1119)
   Memory: 5.3M
   CGroup: /system.slice/ssh.service
           └─460 /usr/sbin/sshd -D
```

Также убедитесь, что служба SSH прослушивает свой стандартный сетевой порт 22:

```console
# lsof -i :22
COMMAND  PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
sshd    1194 root    3u  IPv4 16053268      0t0  TCP *:ssh (LISTEN)
sshd    1194 root    4u  IPv6 16053270      0t0  TCP *:ssh (LISTEN)
```

Наконец остановите службу SSH с помощью:

```console
$ sudo systemctl stop sshd.service
```

В случае, если вы хотите сделать это изменение постоянным и сохраненным после перезагрузки, используйте `systemctl disable sshd.service`. 

Теперь вы можете создать файл конфигурации `xinetd /etc/xinetd.d/ssh` с некоторыми базовыми настройками:

```console
service ssh
{
	disable		= no
	socket_type	= stream
	protocol	= tcp
	wait		= no
	user		= root
	server		= /usr/sbin/sshd
	server_args 	= -i
	flags		= IPv4
	interface	= 192.168.178.1
}
```

Перезапустите службу `xinetd` с помощью:

```console
$ sudo systemctl restart xinetd.service
```

Проверьте, какая служба сейчас прослушивает входящие соединения SSH.

```console
$ sudo lsof -i :22
COMMAND   PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
xinetd  24098 root    5u  IPv4 7345141      0t0  TCP 192.168.178.1:ssh (LISTEN)
```

Мы видим, что служба xinetd взяла на себя управление доступом к порту 22. 

Вот еще несколько подробностей о конфигурации `xinetd`. Основной файл конфигурации - `/etc/xinetd.conf`:

```console
# Simple configuration file for xinetd
#
# Some defaults, and include /etc/xinetd.d/

defaults
{

# Please note that you need a log_type line to be able to use log_on_success
# and log_on_failure. The default is the following :
# log_type = SYSLOG daemon info

}

includedir /etc/xinetd.d
```

Помимо настроек по умолчанию, есть только одна директива для установки каталога включения. В этом каталоге вы можете настроить отдельный файл конфигурации для каждой службы, которую вы хотите обрабатывать с помощью `xinetd`. Мы сделали это выше для службы SSH и назвали файл `/etc/xinetd.d/ssh`. Имена файлов конфигурации могут быть выбраны произвольно, за исключением имен файлов, содержащих точку (`.`) Или оканчивающихся тильдой (`~`). Но широко распространена практика называть файл в честь службы, которую вы хотите настроить. 

Некоторые файлы конфигурации в каталоге `/etc/xinet.d/` уже предоставлены дистрибутивом:

```console
$ ls -l /etc/xinetd.d
total 52
-rw-r--r-- 1 root root 640 Feb  5  2018 chargen
-rw-r--r-- 1 root root 313 Feb  5  2018 chargen-udp
-rw-r--r-- 1 root root 502 Apr 11 10:18 daytime
-rw-r--r-- 1 root root 313 Feb  5  2018 daytime-udp
-rw-r--r-- 1 root root 391 Feb  5  2018 discard
-rw-r--r-- 1 root root 312 Feb  5  2018 discard-udp
-rw-r--r-- 1 root root 422 Feb  5  2018 echo
-rw-r--r-- 1 root root 304 Feb  5  2018 echo-udp
-rw-r--r-- 1 root root 312 Feb  5  2018 servers
-rw-r--r-- 1 root root 314 Feb  5  2018 services
-rw-r--r-- 1 root root 569 Feb  5  2018 time
-rw-r--r-- 1 root root 313 Feb  5  2018 time-udp
```

Эти файлы можно использовать в качестве шаблонов в тех редких случаях, когда вам нужно использовать некоторые устаревшие службы, такие как дневное время, очень ранняя реализация сервера времени. Все эти файлы шаблона содержат директиву `disable = yes`. 

Вот еще несколько подробностей о директивах, используемых в файле примера `/etc/xinetd.d/ssh` для ssh выше.

```console
service ssh
{
	disable		= no
	socket_type	= stream
	protocol	= tcp
	wait		= no
	user		= root
	server		= /usr/sbin/sshd
	server_args 	= -i
	flags		= IPv4
	interface	= 192.168.178.1
}
```

`service`  
Выводит список служб, которыми должен управлять xinetd. Вы можете использовать либо номер порта, например 22, либо имя, сопоставленное с номером порта в `/etc/services`, например `ssh.` 

`{`  
Детальная настройка начинается с открывающей фигурной скобки. 

`disable`  
Чтобы активировать эти настройки, установите для этого параметра значение `no`. Если вы хотите временно отключить эту настройку, вы можете установить для нее значение `yes`. 

`socket_type`  
Вы можете выбрать `stream` для сокетов TCP или `dgram` для сокетов UDP и многое другое. 

`protocol`  
Выберите TCP или UDP. 

`wait`  
Для TCP-соединений обычно установлено значение `no`. 

`user`  
Сервис, запущенный в этой строке, будет принадлежать этому пользователю. 

`server`  
Полный путь к службе, которую должен запустить `xinetd`. 

`server_args`  
Здесь вы можете добавить параметры сервиса. Если запускается суперсервером, для многих сервисов требуется специальная опция. Для SSH это будет опция `-i`. 

`flags`  
Вы можете выбрать IPv4, IPv6 и другие. 

`interface`  
Сетевой интерфейс, которым должен управлять `xinetd`. Примечание: вы также можете выбрать директиву `bind`, которая является синонимом `interface`. 

`}`  
Закончите закрывающей фигурной скобкой. 

Преемниками служб, запускаемых суперсервером `xinetd`, являются модули сокетов systemd. Настроить модуль сокета systemd очень просто и легко, потому что уже есть предопределенный модуль сокета systemd для SSH. Убедитесь, что службы `xinetd` и SSH не запущены. 

Теперь вам просто нужно запустить модуль сокета SSH:

```console
$ sudo systemctl start ssh.socket
```

Чтобы проверить, какая служба сейчас прослушивает порт 22, мы снова используем `lsof`. Обратите внимание, что здесь параметр `-P` использовался для отображения номера порта вместо имени службы в выходных данных:

```console
$ sudo lsof -i :22 -P
COMMAND PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
systemd   1 root   57u  IPv6 14730112      0t0  TCP *:22 (LISTEN)
```

Чтобы завершить этот сеанс, вы должны попытаться войти на свой сервер с помощью клиента SSH по вашему выбору.

>Если `systemctl start ssh.socket` не работает с вашим дистрибутивом, попробуйте `systemctl start sshd.socket`.


## Проверка служб на наличие ненужных демонов

