# 103.3 Урок 2

| **Сертификат:** | LPIC-1                                    |
|:----------------|:------------------------------------------|
| **Версия:**     | 5.0                                       |
| **Тема:**       | 103 Команды GNU и Unix                    |
| **Задача:**     | 103.3 Выполнение базовых манипуляций с файлами |
| **Урок:**       | 2 из 2                                    |


## Как искать файлы

По мере использования машины количество и размер файлов постепенно увеличивается. Иногда бывает сложно найти конкретный файл. К счастью, Linux предоставляет функцию `find` для быстрого поиска файлов. `find` использует следующий синтаксис:

```console
find STARTING_PATH OPTIONS EXPRESSION
```

`STARTING_PATH`  
определяет каталог, в котором начинается поиск. 

`OPTIONS`  
контролирует поведение и добавляет определенные критерии для оптимизации процесса поиска. 

`EXPRESSION`  
определяет поисковый запрос.

```console
$ find . -name "myfile.txt"
./myfile.txt
```

Начальный путь в этом случае - текущий каталог. Параметр `-name` указывает, что поиск основан на имени файла. `myfile.txt` - это имя файла для поиска. При использовании подстановки файлов убедитесь, что выражение заключено в кавычки:

```console
$ find /home/frank -name "*.png"
/home/frank/Pictures/logo.png
/home/frank/screenshot.png
```

Эта команда находит все файлы, оканчивающиеся на `.png`, начиная с каталога `/home/frank/` и ниже. Если вы не понимаете, как используется звездочка (`*`), это описано в предыдущем уроке.


## Использование критериев для ускорения поиска

Используйте `find` для поиска файлов по *типу*, *размеру* или *времени*. Указав один или несколько вариантов, вы получите желаемые результаты за меньшее время. 

Переключение на поиск файлов по типу включает: 

`-type f`  
поиск файлов. 

`-type d`  
поиск по каталогу. 

`-type l`  
поиск по символической ссылке.

```console
$ find . -type d -name "example"
```

Эта команда находит все каталоги в текущем каталоге и ниже, которые имеют имя `example`. 

Другие критерии, которые можно использовать с поиском, включают: 

`-name`  
выполняет поиск по заданному имени. 

`-iname`  
поиск по имени, однако регистр не важен (т. е. тестовый пример `myFile` похож на `MYFILE`). 

`-not`  
возвращает те результаты, которые не соответствуют тесту. 

`-maxdepth N`  
выполняет поиск как в текущем каталоге, так и в подкаталогах на `N` уровней.


## Поиск файлов по времени изменения

`find` также позволяет фильтровать иерархию каталогов в зависимости от того, когда файл был изменен:

```console
$ sudo find / -name "*.conf" -mtime 7
/etc/logrotate.conf
```

Эта команда будет искать все файлы во всей файловой системе (начальный путь - это корневой каталог, т.е. `/`), которые заканчиваются символами `.conf` и были изменены за последние семь дней. Эта команда потребует повышенных привилегий для доступа к каталогам, начинающимся с основы структуры каталогов системы, поэтому здесь используется `sudo`. Аргумент, переданный в `mtime`, представляет количество дней с момента последнего изменения файла.


## Поиск файлов по размеру

`find` также может находить файлы по размеру. Например, поиск файлов размером более 2 ГБ в `/var`:

```console
$ sudo find /var -size +2G
/var/lib/libvirt/images/debian10.qcow2
/var/lib/libvirt/images/rhel8.qcow2
```

Параметр `-size` отображает файлы размеров, соответствующих переданному аргументу. Вот некоторые примеры аргументов: 

`-size 100b`  
файлы размером ровно 100 байт. 

`-size +100к`  
файлы размером более 100 килобайт. 

`-sizw -20M`  
файлы размером менее 20 мегабайт. 

`-size +2G`  
файлы размером более 2 гигабайт.

>Чтобы найти пустые файлы, мы можем использовать: `find . -size 0b` или `find . -empty`.


## Действия по набору результатов

После завершения поиска можно выполнить действие с результирующим набором с помощью `-exec`:

```console
$ find . -name "*.conf" -exec chmod 644 '{}' \;
```

Это фильтрует каждый объект в текущем каталоге (`.`) и ниже на предмет имен файлов, заканчивающихся на `.conf`, а затем выполняет команду `chmod 644` для изменения прав доступа к файлам для результатов. 

Пока не беспокойтесь о значении `'{}' \;` как это будет обсуждаться позже.


## Использование `grep` для фильтрации файлов на основе содержимого

`grep` используется для поиска вхождения ключевого слова. 

Рассмотрим ситуацию, когда нам нужно найти файлы по содержимому:

```console
$ find . -type f -exec grep "lpi" '{}' \; -print
./.bash_history
Alpine/M
helping/M
```

Это будет искать каждый объект в текущей иерархии каталогов (`.`), который является файлом (`-type f`), а затем выполняет команду `grep «lpi»` для каждого файла, который удовлетворяет условиям. Файлы, соответствующие этим условиям, печатаются на экране (`-print`). Фигурные скобки (`{}`) заменяют результаты поиска. `{}` Заключены в одинарные кавычки (`'`), чтобы избежать передачи файлов `grep` с именами, содержащими специальные символы. Команда `-exec` заканчивается точкой с запятой (`;`), которую следует экранировать (`\;`), чтобы избежать интерпретации оболочкой. 

Добавление опции `-delete` в конец выражения приведет к удалению всех совпадающих файлов. Эту опцию следует использовать, если вы уверены, что результаты соответствуют только тем файлам, которые вы хотите удалить. 

В приведенном ниже примере `find` находит все файлы в иерархии, начиная с текущего каталога, а затем удаляет все файлы, которые заканчиваются символами `.bak`:

```console
$ find . -name "*.bak" -delete
```

## Архивирование файлов

### Команда `tar` (архивирование и сжатие)

Команда `tar`, сокращение от «ленточный архив(атор)», используется для создания архивов `tar` путем преобразования группы файлов в архив. Архивы создаются таким образом, чтобы можно было легко перемещать или создавать резервные копии группы файлов. Думайте о `tar` как об инструменте, который создает клей, на который файлы можно прикреплять, группировать и легко перемещать. 

`tar` также имеет возможность извлекать архивы `tar`, отображать список файлов, включенных в архив, а также добавлять дополнительные файлы в существующий архив. Синтаксис команды `tar` выглядит следующим образом:

```console
tar [OPERATION_AND_OPTIONS] [ARCHIVE_NAME] [FILE_NAME(S)]
```

`OPERATION`  
Разрешен и обязателен только один аргумент операции. Наиболее часто используемые операции: 
`--create (-c)`  
Создает новый `tar-архив`. 

`--extract (-x)`  
Извлеките весь архив или один или несколько файлов из архива. 

`--list (-t)`  
Отобразите список файлов, включенных в архив. 

`OPTIONS`  
Наиболее часто используемые варианты: 

`--verbose (-v)`  
Показать файлы, обрабатываемые командой `tar`. 

`--file=archive=name (-f arhive-name`)  
Задает имя файла архива. 

`ARCHIVE_NAME`  
Имя архива.  

`FILE_NAME(S)`  
Список извлекаемых файлов, разделенных пробелами. Если не указано иное, извлекается весь архив.


### Создание архива

Допустим, у нас есть каталог с именем `stuff` в текущем каталоге, и мы хотим сохранить его в файл с именем `archive.tar`. Мы бы запустили следующую команду:

```console
$ tar -cvf archive.tar stuff
stuff/
stuff/service.conf
```

Вот что на самом деле означают эти переключатели: 

`-c`  
Создает архив. 

`-v`  
Отображает прогресс в терминале при создании архива, также известный как «подробный» режим. `-v` в этих командах всегда необязателен, но полезен. 

`-f`  
Позволяет указать имя файла архива. Обычно для архивации одного каталога или одного файла в Linux мы используем:

```console
tar -cvf NAME-OF-ARCHIVE.tar /PATH/TO/DIRECTORY-OR-FILE
```

>tar работает рекурсивно. Он будет выполнять необходимые действия с каждым последующим каталогом внутри указанного каталога.

Чтобы заархивировать несколько каталогов одновременно, мы перечисляем все каталоги, ограничивая их пробелом в разделе `/PATH/TO/DIRECTORY-OR-FILE`:

```console
$ tar -cvf archive.tar stuff1 stuff2
```

Это создаст архив `stuff1` и `stuff2` в `archive.tar`.


### Извлечение архива

Мы можем извлечь архив с помощью `tar`:

```
$ tar -xvf archive.tar
stuff/
stuff/service.conf
```

Это распакует содержимое `archive.tar` в текущий каталог. 

Эта команда аналогична команде создания архива, использованной выше, за исключением переключателя `-x`, который заменяет переключатель `-c`. 

Чтобы извлечь содержимое архива в определенный каталог, мы используем `-C`:

```console
$ tar -xvf archive.tar -C /tmp
```

Это распакует содержимое `archive.tar` в каталог `/tmp`.

```console
$ ls /tmp
stuff
```

### Сжатие при помощи `tar`

Команда GNU `tar`, включенная в дистрибутивы Linux, может создать архив `.tar`, а затем сжать его с помощью сжатия `gzip` или `bzip2` одной командой:

```console
$ tar -czvf name-of-archive.tar.gz stuff
```

Эта команда создаст сжатый файл с использованием алгоритма `gzip` (`-z`). 

Хотя сжатие `gzip` чаще всего используется для создания файлов `.tar.gz` или `.tgz`, `tar` также поддерживает сжатие `bzip2`. Это позволяет создавать сжатые файлы `bzip2`, часто называемые файлами `.tar.bz2`, `.tar.bz` или `.tbz`. 

Для этого заменим `-z` для `gzip` на `-j` для `bzip2`:

```console
$ tar -cjvf name-of-archive.tar.bz stuff
```

Чтобы распаковать файл, мы заменяем `-c` на `-x`, где `x` означает «извлечь»:

```console
$ tar -xzvf archive.tar.gz
```

`gzip` работает быстрее, но обычно сжимает немного меньше, поэтому вы получаете файл несколько большего размера. `bzip2` работает медленнее, но сжимает немного больше, поэтому вы получаете файл несколько меньшего размера. Однако в целом `gzip` и `bzip2` - это практически одно и то же, и оба работают одинаково. 

В качестве альтернативы мы можем применить сжатие `gzip` или `bzip2`, используя команду `gzip` для сжатия `gzip` и команду `bzip` для сжатия `bzip`. Например, чтобы применить сжатие `gzip`, используйте:

```console
gzip FILE-TO-COMPRESS
```

`gzip`  
создает сжатый файл с тем же именем, но с окончанием `.gz`. 

`gzip`  
удаляет исходные файлы после создания сжатого файла. 

Команда `bzip2` работает аналогичным образом. 

Для распаковки файлов мы используем либо `gunzip`, либо `bunzip2` в зависимости от алгоритма, используемого для сжатия файла.


### Команда `cpio`

`cpio` означает «копировать, копировать». Он используется для обработки архивных файлов, таких как файлы `*.cpio*` или `.tar`. 

`cpio` выполняет следующие операции: 
* Копирование файлов в архив. 
* Извлечение файлов из архива. 
 
Он берет список файлов со стандартного ввода (в основном вывод из `ls`). 

Для создания `cpio` архива мы используем:

```console
$ ls | cpio -o > archive.cpio
```

Параметр `-o` указывает `cpio` на создание вывода. В этом случае создается выходной файл `archive.cpio`. 

Команда `ls` выводит список содержимого текущего каталога, которое необходимо заархивировать. 

Для распаковки архива мы используем:

```console
$ cpio -id < archive.cpio
```

Параметр `-i` используется для извлечения. Параметр `-d` создаст папку назначения. Символ `<` представляет стандартный ввод. Входной файл для извлечения - `archive.cpio`.


### Команда `dd`

`dd` копирует данные из одного места в другое. Синтаксис командной строки `dd` отличается от многих других программ Unix, он использует синтаксис `option=value` для своих параметров командной строки, а не стандартные форматы GNU `-option value` или `--option=value`:

```console
$ dd if=oldfile of=newfile
```

Эта команда скопирует содержимое `oldfile` в `newfile`, где `if=` - это входной файл, а `of=` относится к выходному файлу.

>Команда `dd` обычно ничего не выводит на экран, пока команда не завершится. Если указать параметр `status=progress`, консоль отобразит объем работы, выполненной командой. Например: `dd status=progress if=oldfile of=newfile`.

`dd` также используется для преобразования данных в верхний/нижний регистр или записи непосредственно на блочные устройства, такие как `/dev/sdb`:

```console
$ dd if=oldfile of=newfile conv=ucase
```

Это скопирует все содержимое старого файла в новый файл и сделает весь текст заглавными.

Следующая команда создаст резервную копию всего жесткого диска, расположенного в `/dev/sda`, в файл с именем `backup.dd`:

```console
$ dd if=/dev/sda of=backup.dd bs=4096
```


## Упражнения для закрепления

1. Рассмотрим следующий список:

```console
$ find /home/frank/Documents/ -type d
/home/frank/Documents/
/home/frank/Documents/animal
/home/frank/Documents/animal/domestic
/home/frank/Documents/animal/wild
```

* Какие файлы выводит эта команда? 
* В каком каталоге начинается поиск?

2. Пользователь желает сжать свою резервную папку. Он использует следующую команду:

```console
$ tar cvf /home/frank/backup.tar.gz /home/frank/dir1
```

Какой опции не хватает для сжатия резервной копии с использованием алгоритма gzip?


## Упражнения на размышление

1. Как системный администратор, он должен выполнять регулярные проверки на предмет удаления объемных файлов. Эти объемные файлы находятся в `/var` и имеют расширение `.backup`. 

* Запишите команду, используя `find`, чтобы найти эти файлы: 

* Анализ размеров этих файлов показывает, что они варьируются от `100МБ` до `1ГБ`. Завершите предыдущую команду этой новой информацией, чтобы вы могли найти эти файлы резервных копий размером от `100МБ` до `1ГБ`: 

* Наконец, завершите эту команду действием удаления, чтобы эти файлы были удалены: 

2. В каталоге `/var` есть четыре файла резервных копий:

```console
db-jan-2018.backup
db-feb-2018.backup
db-march-2018.backup
db-apr-2018.backup
```

* Используя `tar`, укажите команду, которая создаст архивный файл с именем `db-first-Quarter-2018.backup.tar`:

* Используя `tar`, укажите команду, которая будет создавать архив и сжимать его с помощью `gzip`. Обратите внимание, что имя результирующего файла должно заканчиваться на `.gz`:


## Резюме

В этом разделе вы узнали: 
* Как найти файлы с `find`. 
* Как добавить критерии поиска на основе времени, типа или размера файла, указав аргумент `find`. 
* Как действовать на возвращенный набор. 
* Как архивировать, сжимать и распаковывать файлы с помощью `tar`. 
* Обработка архивов с помощью `cpio`. 
* Копирование файлов с помощью `dd`.


## Ответы на упражнения для закрепления

**1. Рассмотрим следующий список:**  

```console
$ find /home/frank/Documents/ -type d
/home/frank/Documents/
/home/frank/Documents/animal
/home/frank/Documents/animal/domestic
/home/frank/Documents/animal/wild
```

* Какие файлы выводит эта команда?  
Директории

* В каком каталоге начинается поиск?
`/home/frank/Documents/`

**2. Пользователь желает сжать свою резервную папку. Он использует следующую команду:**

```console
$ tar cvf /home/frank/backup.tar.gz /home/frank/dir1
```

**Какой опции не хватает для сжатия резервной копии с использованием алгоритма gzip?**  
Какой опции не хватает для сжатия резервной копии с использованием алгоритма `gzip`? Опция `-z`.


## Ответы на упражнения для размышления

**1. Как системный администратор, он должен выполнять регулярные проверки на предмет удаления объемных файлов. Эти объемные файлы находятся в `/var` и имеют расширение `.backup`.**  

* Запишите команду, используя `find`, чтобы найти эти файлы: 
```console
$ find /var -name *.backup
```

* Анализ размеров этих файлов показывает, что они варьируются от `100МБ` до `1ГБ`. Завершите предыдущую команду этой новой информацией, чтобы вы могли найти эти файлы резервных копий размером от `100МБ` до `1ГБ`: 
```console
$ find /var -name *.backup -size +100M -size -1000M
```

* Наконец, завершите эту команду действием удаления, чтобы эти файлы были удалены: 
```console
$ find /var -name *.backup -size +100M -size -1000M -delete
```

**2. В каталоге `/var` есть четыре файла резервных копий:**

```console
db-jan-2018.backup
db-feb-2018.backup
db-march-2018.backup
db-apr-2018.backup
```

* Используя `tar`, укажите команду, которая создаст архивный файл с именем `db-first-Quarter-2018.backup.tar`:
```console
$ tar -cvf db-first-quarter-2018.backup.tar db-jan-2018.backup db-feb-2018.backup db-march-2018.backup db-apr-2018.backup
```

* Используя `tar`, укажите команду, которая будет создавать архив и сжимать его с помощью `gzip`. Обратите внимание, что имя результирующего файла должно заканчиваться на `.gz`:
```console
$ tar -zcvf db-first-quarter-2018.backup.tar.gz db-jan-2018.backup db-feb-2018.backup db-march-2018.backup db-apr-2018.backup
```
