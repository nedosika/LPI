# 103.5 Урок 2

| Сертификат:   | LPIC-1                                      |
|:--------------|:--------------------------------------------|
| Версия:       | 5.0                                         |
| Тема:         | 103 GNU и Unix комманды                     |                           
| Цель:         | 103.5 Создание, контроль и уничтожение процессов |
| Урок:         | 2 из 2                                      |


# Введение

Инструменты и утилиты, рассмотренные в предыдущем уроке, в целом очень полезны для контроля процессов. Однако, системному администратору возможно пригодятся еще некоторые. В этом уроке мы обсудим концепцию терминальных мультиплексоров и узнаем о *GNU Screen* и *tmux*. Несмотря на то, что сейчас уже существуют отличные терминальные эмуляторы, - мультиплексоры по-прежнему имеют ряд интересных и мощных функций для продвинутого системного администрирования.


# Особенности терминальных мультиплексоров

В электронике мультиплексор(или `mux`) это устройство, которое позволяет подключать несколько входов к одному выходу. Таким образом, мультиплексор дает нам возможность переключаться между различными входами по мере необходимости. Не смотря на то, что `screen` и `tmux` разные, они имеют ряд общих функций: 

* В результате их вызова запускаются сессии, которые будут содержать как минимум одно окно. 
* Окна содержат программы. 
* Окна можно разделить на области или панели, что может повысить продуктивность, при одновременной работе с разными программами. 
* Легкость управления: для запуска большинства команд используются комбинации клавиш, так называемые префиксы команд или командные клавиши, за которыми следует определенный символ. 
* Сессии можно отключать от текущего терминала(таким образом программы отправляются в фоновый режим и продолжают работать). Это гарантирует, что программа полностью отработает, независимо от закрытия или зависания терминала или потери удаленного соединения. 
* Позволяют подключаться к сокету. 
* Имеют режим копирования. 
* Оба легко настраиваются.


# GNU Screen

В ранние годы Unix(1970-1980-е) компьютеры в основном состояли из терминалов, подключенных к центральному компьютеру. Это было все - никаких окон или вкладок. И это стало причиной создания *GNU Screen* в 1987 году: эмуляция нескольких независимых *VT100 экранов* на одном физическом терминале.

## Окна

GNU Screen вызывается простым вводом `screen` в терминале. Сначала вы увидите приветственное сообщение:
```console
GNU Screen version 4.05.00 (GNU) 10-Dec-16

Copyright (c) 2010 Juergen Weigert, Sadrul Habib Chowdhury
Copyright (c) 2008, 2009 Juergen Weigert, Michael Schroeder, Micah Cowan, Sadrul Habib Chowdhury
Copyright (c) 1993-2002, 2003, 2005, 2006, 2007 Juergen Weigert, Michael Schroeder
Copyright (c) 1987 Oliver Laumann
(...)
```
Нажмите <kbd>Пробел</kbd> или <kbd>Enter</kbd>, чтобы закрыть сообщение, и вам будет показана командная строка:
```console
$
```
Может показаться, что ничего не произошло, но факт состоит в том, что `screen` уже создал и управляет своей первой сессией и окном. Префикс команд `screen` - <kbd>Ctrl</kbd>+<kbd>a</kbd>. Чтобы увидеть все окна в нижней части дисплея терминала, введите <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>w</kbd>:
```console
0*$ bash
```
Вот оно, наше пока единственное окно! Обратите внимание, что счет начинается с `0`. Чтобы создать еще одно окно, нажмите <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>c</kbd>. Вы увидите новое приглашение кммандной строки. Давайте запустим `ps` в этом новом окне:
```console
$ ps
  PID TTY          TIME CMD
  974 pts/2    00:00:00 bash
  981 pts/2    00:00:00 ps
```
и снова нажмите <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>w</kbd>:
```console
0-$ bash  1*$ bash
```
Здесь у нас есть два окна(обратите внимание на звездочку, указывающую на то, что отображается в данный момент). Однако, так как они были вызваны из Bash, им обоим было дано одно и то же имя. Поскольку мы запустили `ps` в нашем текущем окне, давайте переименуем его и назовем таким-же именем. Для этого вам нужно нажать <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>A</kbd> и при появлении запроса набрать новое имя окна(`ps`):
```console
Set window's title to: ps
```
Теперь давайте создадим еще одно окно, но с самого начала дадим ему имя: `yetanotherwindow`. Это достигается путем вызова `screen` с ключом `-t`:
```console
$ screen -t yetanotherwindow
```
Перемещаться между окнами можно разными способами: 
* Используя <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>n</kbd> (перейти к следующему окну) и <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>p</kbd> (перейти к предыдущему окну). 
* Используя <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>*номер*</kbd> (перейти к окну с номером).
* Используя <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>"</kbd>, чтобы увидеть список всех окон. 
* Вы можете перемещаться вверх и вниз с помощью клавиш со стрелками и выбрать то, которое вы хотите, с помощью <kbd>Enter</kbd>:
```console
Num Name                                                Flags

   0 bash                                                   $
   1 ps                                                     $
   2 yetanotherwindow
```
При работе с окнами важно помнить следующее: окна запускают свои программы совершенно независимо друг от друга. Программы будут продолжать работать, даже если их окно не отображается(также, когда `screen` сессия отсоединена, как мы вскоре увидим). Чтобы удалить окно, просто завершите программу, работающую в нем (как только последнее окно будет удалено, `screen` завершит свою работу). Или используйте <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>k</kbd> в окне, которое вы хотите удалить; вас попросят подтвердить:
```console
Really kill this window [y/n]

Window 0 (bash) killed.
```

## Области (Regions)

`screen` может разделить экран терминала на несколько областей для размещения окон. Это разделение может быть горизонтальным (<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>S</kbd>) или вертикальным (<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>|</kbd>). Единственное, что будет отображаться в новой области, это `--` внизу, что означает, что он пуст:
```console
1 ps                                                               --
```
Чтобы перейти в новую область, нажмите <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>Tab</kbd>. Теперь вы можете добавить окно одним из методов, которые мы уже видели, например: <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>2</kbd>. Теперь `--` должно было превратиться в `2 yetanotherwindow`:
```console
$ ps                                                  $
  PID TTY          TIME CMD
 1020 pts/2    00:00:00 bash
 1033 pts/2    00:00:00 ps
$ screen -t yetanotherwindow




   1 ps                                                                2 yetanotherwindow
```
При работе с областями следует учитывать следующие важные аспекты: 
* Вы перемещаетесь между областями, нажимая <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>Tab</kbd>. 
* Вы можете завершить все области, кроме текущей, с помощью <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>Q</kbd>. 
* Вы можете завершить текущую область с помощью <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>X</kbd>. 
* Завершение области не завершает связанное с ней окно.

## Сессии

До сих пор мы имели дело с несколькими окнами и областями, но все они принадлежали одной и той же сессии. Теперь настало время разобраться с сессиями. Чтобы увидеть список всех сессий, наберите `screen -list` или `screen -ls`:
```console
$ screen -list
There is a screen on:
        1037.pts-0.debian       (08/24/19 13:53:35)     (Attached)
1 Socket in /run/screen/S-carol.
```
На данный момент это наша единственная сессия: 
* PID   
`1037` 
* Name  
`pts-0.debian` (индикатор терминала, в нашем случае, подчиненный псевдотерминал и имя хоста). 
* Status  
`Attached` 

Давайте создадим новую сессию, дав ей более описательное имя:
```console
$ screen -S "second session"
```
Дисплей терминала очистится, и вам будет показано новое приглашение. Вы можете проверить наличие сессий еще раз:
```console
$ screen -ls
There are screens on:
        1090.second session     (08/24/19 14:38:35)     (Attached)
        1037.pts-0.debian       (08/24/19 13:53:36)     (Attached)
2 Sockets in /run/screen/S-carol.
```
Чтобы завершить сессию, закройте все её окна или просто введите команду `screen -S SESSION-PID -X quit` (вместо этого вы также можете указать имя сессии). Избавимся от нашей первой сессии:
```console
$ screen -S 1037 -X quit
```
Вы будете отправлены обратно в ваше окно терминала вне `screen`. Но помните, что наша вторая сессия все еще работает:
```console
$ screen -ls
There is a screen on:
	1090.second session	(08/24/19 14:38:35)	(Detached)
1 Socket in /run/screen/S-carol.
```
Однако, поскольку мы уничтожили его родительскую сессию, ему была присвоена новая метка: `Detached`.

## Отключение сессии

По ряду причин вы можете захотеть отключить сессию от ее терминала: 
* Чтобы позволить вашему рабочему компьютеру продолжить работу и позже подключаться к нему удаленно из дома. 
* Чтобы поделиться сессией с другими пользователями. 

Вы можете отключить сесию с помощью комбинации клавиш <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>d</kbd>. При этом вы вернетесь в свой терминал:
```console
[detached from 1090.second session]
$
```
Чтобы снова подключиться к сессии, используйте команду `screen -r SESSION-PID`. В качестве альтернативы вы можете использовать параметр `SESSION-NAME`, как мы видели ранее. Если существует только одна сессия, то ни один из параметров не является обязательным:
```console
$ screen -r
```
Этой команды достаточно, чтобы повторно подключиться к нашей сессии:
```console
$ screen -ls
There is a screen on:
        1090.second session      (08/24/19 14:38:35)     (Attached)
1 Socket in /run/screen/S-carol.
```
Важные параметры для повторного подключения к сессии:
* `-d -r`  
Повторно подключается к сессии и, если необходимо, сначала отключается от нее. 
* `-d -R`  
То же, что и `-d -r`, но `screen` сначала создаст сессию, если ее не существует.
* `-d -RR`  
То же, что и `-d -R`. Однако, использует первую сессию, если доступно более одной сессии. 
* `-D -r`  
Повторно подключается к сессии. При необходимости сначала отключится и выйдет из системы удаленно. 
* `-D -R`  
Если сессия запущена, подключается повторно (при необходимости сначала отключится и выйдет из системы удаленно). Если она не запущена, создаст ее и уведомит пользователя. 
* `-D -RR`  
То же, что и `-D -R` - только сильнее. 
* `-d -m`  
Запускает `screen` в автономном режиме. Он создает новую сессию, но не подключается к ней. Это полезно для сценариев запуска системы. 
* `-D -m` То же, что и `-d -m`, но не запускает новый процесс. Команда завершится, если сессия закроется. 

Чтобы узнать о других возможностях, прочтите страницы руководства для `screen`.

## Копирование и вставка: режим прокрутки

*GNU Screen* имеет режим копирования или прокрутки. После ввхода в этот режим, вы можете перемещать курсор в текущем окне и по содержимому его истории с помощью клавиш со стрелками. Вы можете помечать и копировать текст в окнах. Для этого следует: 
* Войти в режим копирования/прокрутки: <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>[</kbd>. 
* Переместиться в начало фрагмента текста, который вы хотите скопировать, с помощью клавиш со стрелками. Отметьте начало фрагмента текста, который вы хотите скопировать: <kbd>Пробел</kbd>. 
* Переместиться в конец фрагмента текста, который вы хотите скопировать, с помощью клавиш со стрелками. Отметьте конец фрагмента текста, который вы хотите скопировать: <kbd>Пробел</kbd>.
* Перейти в выбранное вами окно и вставить фрагмент текста: <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>]</kbd>.

## Настройка screen

Общесистемным файлом конфигурации screen является `/etc/screenrc`. В качестве альтернативы можно использовать настройки на уровне пользователя `~/.screenrc`. Файл включает четыре основных раздела конфигурации: 

* `SCREEN SETTINGS`  
Вы можете определить общие настройки, указав директиву, за которой следует пробел и значение, как в: `defscrollback 1024`. 
* `SCREEN KEYBINDINGS`  
Этот раздел весьма интересен, поскольку позволяет вам переопределить сочетания клавиш, которые могут мешать повседневному использованию терминала. Используйте ключевое слово `bind`, символ, который следует использовать после префикса команды и команду разделенные пробелами, например: `bind l kill` (этот параметр изменит способ закрытия окна по умолчанию на <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>l</kbd>). 

Чтобы отобразить все привязки экрана, введите <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>?</kbd> или обратитесь к странице руководства. 

>Конечно, вы также можете изменить сам префикс команды. Например, чтобы перейти от <kbd>Ctrl</kbd>+<kbd>a</kbd> к <kbd>Ctrl</kbd>+<kbd>b</kbd>, просто добавьте эту строку: `escape ^ Bb`.
 
* `TERMINAL SETTINGS`  
Этот раздел включает в себя настройки, связанные, среди прочего, с размерами окон терминала и буферами. Например, чтобы включить неблокирующий режим, чтобы лучше справляться с нестабильными ssh-соединениями, используется следующая конфигурация: `defnonblock 5`. 
* `STARTUP SCREENS`  
Вы можете включать команды для запуска различных программ при запуске `screen`; например: `screen -t top top` (`screen` откроет окно с именем "top" с `top` внутри).


# tmux

`tmux` был выпущен в 2007 году. Хотя он и очень похож на `screen`, он имеет несколько заметных отличий: 
* Модель клиент-сервер: сервер предоставляет несколько сессий, каждая из которых может иметь несколько окон, связанных с ней, которые, в свою очередь, могут использоваться различными клиентами. 
* Интерактивный выбор сессий, окон и клиентов через меню. 
* Одно и то же окно можно связать с несколькими сессиями. 
* Доступность раскладок клавиш как `vim`, так и `Emacs`. Поддержка UTF-8 и 256-цветного терминала.

## Окна

`tmux` можно вызвать, просто набрав `tmux` в командной строке. Вам будет показано приглашение оболочки и строка состояния внизу окна:
```
[0] 0:bash*                                                        "debian" 18:53 27-Aug-19
```
Помимо `hostname`, времени и даты, в строке состояния отображается следующая информация:
* Название сессии  
`[0]` 
* Номер окна  
`0:` 
* Имя окна  
`bash *`. По умолчанию это имя программы, запущенной внутри окна, и, в отличие от `screen`, `tmux` автоматически обновит его, чтобы отразить текущую запущенную программу. Обратите внимание на звездочку, указывающую, что это текущее видимое окно. 

Вы можете назначать имена сессиям и окнам при вызове `tmux`:
```console
$ tmux new -s "LPI" -n "Window zero"
```
Строка состояния изменится соответственно:
```console
[LPI] 0:Window zero*                                                 "debian" 19:01 27-Aug-19
```
Префикс команды `tmux` - <kbd>Ctrl</kbd>+<kbd>b</kbd>. Чтобы создать новое окно, просто введите <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>c</kbd>; вы перейдете к новому запросу, и в строке состояния отобразится новое окно:
```console
[LPI] 0:Window zero- 1:bash*                                         "debian" 19:02 27-Aug-19
```
Поскольку Bash является базовой оболочкой, новому окну по умолчанию дается это имя. Запустите `top` и посмотрите, как имя изменится на `top`:
```console
[LPI] 0:Window zero- 1:top*                                         "debian" 19:03 27-Aug-19
```
В любом случае вы можете переименовать окно с помощью <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>,</kbd>. При появлении запроса введите новое имя и нажмите <kbd>Enter</kbd>:
```console
(rename-window) Window one
```
Вы можете отобразить список всех окон для последующего выбора при помощи <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>w</kbd> (используйте клавиши со стрелками для перемещения вверх и вниз и <kbd>Enter</kbd> для выбора):
```console
(0)  0: Window zero- "debian"
(1)  1: Window one* "debian"
```
Подобно `screen`, мы можем переходить из одного окна в другое с помощью: 
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>n</kbd> 
	перейти к следующему окну. 
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>p</kbd> 
	перейти к предыдущему окну. 
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>число</kbd> 
	перейти к номеру окна. 
	
Чтобы завершить работу окна, используйте <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>&</kbd>. Вам будет предложено подтвердить:
```console
kill-window Window one? (y/n)
```
К другим интересным оконным командам относятся:
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>f</kbd>  
найти окно по имени. 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>.</kbd>  
изменить порядковый номер окна. 

Чтобы увидеть весь список команд, обратитесь к странице руководства.

## Панели

Средство разделения экрана `screen` также присутствует в `tmux`. Однако они называются не областями, а панелями. Наиболее важное различие между областями и панелями состоит в том, что последние представляют собой полные псевдотерминалы, связанные с окном. Это означает, что уничтожение панели также приведет к уничтожению ее псевдотерминала и всех связанных с ним программ, работающих внутри. Чтобы разделить окно по горизонтали, мы используем <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>"</kbd>:
```console
Tasks:  93 total,   1 running,  92 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  4050960 total,  3730920 free,   114880 used,   205160 buff/cache
KiB Swap:  4192252 total,  4192252 free,        0 used.  3716004 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
 1340 carol     20   0   44876   3400   2800 R  0.3  0.1   0:00.24 top
    1 root      20   0  139088   6988   5264 S  0.0  0.2   0:00.50 systemd
    2 root      20   0       0      0      0 S  0.0  0.0   0:00.00 kthreadd
    3 root      20   0       0      0      0 S  0.0  0.0   0:00.04 ksoftirqd/0
    4 root      20   0       0      0      0 S  0.0  0.0   0:01.62 kworker/0:0
    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H
    7 root      20   0       0      0      0 S  0.0  0.0   0:00.06 rcu_sched
    8 root      20   0       0      0      0 S  0.0  0.0   0:00.00 rcu_bh
    9 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0
   10 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 lru-add-drain
   11 root      rt   0       0      0      0 S  0.0  0.0   0:00.01 watchdog/0
   12 root      20   0       0      0      0 S  0.0  0.0   0:00.00 cpuhp/0
$
───────────────────────────────────────────────────────────────────────────────────────────────
$












[LPI] 0:Window zero- 1:Window one*                                      "debian" 19:05 27-Aug-19
```
Чтобы разделить его по вертикали, используйте <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>%</kbd>:
```console
                                                                            │$
    1 root      20   0  139088   6988   5264 S  0.0  0.2   0:00.50 systemd     │
                                                                               │
    2 root      20   0       0      0      0 S  0.0  0.0   0:00.00 kthreadd    │
                                                                               │
    3 root      20   0       0      0      0 S  0.0  0.0   0:00.04 ksoftirqd/0 │
    4 root      20   0       0      0      0 S  0.0  0.0   0:01.62 kworker/0:0 │
    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H│
    7 root      20   0       0      0      0 S  0.0  0.0   0:00.06 rcu_sched   │
    8 root      20   0       0      0      0 S  0.0  0.0   0:00.00 rcu_bh      │
    9 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0 │
                                                                               │
   10 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 lru-add-drai│
n                                                                              │
   11 root      rt   0       0      0      0 S  0.0  0.0   0:00.01 watchdog/0  │
                                                                               │
   12 root      20   0       0      0      0 S  0.0  0.0   0:00.00 cpuhp/0     │
                                                                               │
$                                                                              │
───────────────────────────────────────────────────────────────────────────────┴───────────────
$















[LPI] 0:Window zero- 1:Window one*                                      "debian" 19:05 27-Aug-19
```
Чтобы завершить работу текущей панели (вместе с работающим в ней псевдотерминалом и со всеми связанными программами), используйте <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>x</kbd>. Вам будет предложено подтвердить ваше решение в строке состояния:
```consoleconsole
kill-pane 1? (y/n)
```
Важные команды панели: 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>↑</kbd>, <kbd>↓</kbd>, <kbd>←</kbd>, <kbd>→</kbd>  
переключиться между панелями. 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>;</kbd>  
перейти к последней активной панели. 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>Ctrl</kbd>+<kbd>arrow key</kbd>  
изменить размер панели на одну строку. 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>Alt</kbd>+<kbd>arrow key</kbd>  
изменить размер панели на пять строк. 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>{</kbd>  
поменять местами панели (текущие на предыдущие). 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>}</kbd>  
поменять местами панели (с текущей на следующую). 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>z</kbd>  
увеличить/уменьшить панель.
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>t</kbd>  
`tmux` отображает на панели причудливые часы (убейте их, нажав <kbd>q</kbd>). 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>!</kbd>  
превратить панель в окно. 

Чтобы прочитать весь список команд, обратитесь к странице руководства.

## Сессии

Чтобы просмотреть список сессий в `tmux`, вы можете использовать <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>s</kbd>:
```console
(0) + LPI: 2 windows (attached)
```
В качестве альтернативы вы можете использовать команду `tmux ls`:
```console
$ tmux ls
LPI: 2 windows (created Tue Aug 27 19:01:49 2019) [158x39] (attached)
```
Мы видим только одну сессию (LPI), которая включает в себя два окна. Давайте создадим новую сессию из нашей текущей сессии. Этого можно добиться, нажав <kbd>Ctrl</kbd>+<kbd>b</kbd>, введите в командной строке `:new` и нажмите <kbd>Enter</kbd>. Вы будете отправлены в новую сессию, что можно увидеть в строке состояния:
```console
[2] 0:bash*                                                       "debian" 19:15 27-Aug-19
```
По умолчанию `tmux` назвал сеанс `2`. Чтобы переименовать его, используйте <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>$</kbd>. При появлении запроса введите новое имя и нажмите <kbd>Enter</kbd>:
```console
(rename-session) Second Session
```
Вы можете переключать сессии с помощью <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>s</kbd> (используйте клавиши со стрелками и <kbd>enter</kbd>):
```console
(0) + LPI: 2 windows
(1) + Second Session: 1 windows (attached)
```
Чтобы завершить сессию, вы можете использовать команду `tmux kill-session -t SESSION-NAME`. Если вы введете команду в текущую подключенную сессию, вы выйдете из `tmux` и вернетесь к исходной сессии терминала:
```console
$ tmux kill-session -t "Second Session"
[exited]
$
```

## Отключение сессии

Завершив вторую сессию, мы оказались вне `tmux`. Однако у нас все еще есть одна активная сессия. Выведите при помощи `tmux` список сессий, и вы обязательно найдете его там:
```console
$ tmux ls
LPI: 2 windows (created Tue Aug 27 19:01:49 2019) [158x39]
```
Однако эта сессия отключена от своего терминала. Мы можем подключить его с помощью `tmux attach -t SESSION-NAME` (`attach` можно заменить на `at` или просто `a`). Когда есть только одна сессия, указание имени необязательно:
```console
$ tmux a
```
Теперь вы вернулись к сессии; чтобы отключиться от неё, нажмите <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>d</kbd>:
```console
[detached (from session LPI)]
$
```
>Одину и туже же сессию можно подключить к нескольким терминалам. Если вы хотите подключить сессию, убедившись, что она сначала отключена от любых других терминалов, используйте ключ `-d`: `tmux attach -d -t SESSION-NAME`.

Важные команды для подключения/отключения сессий:
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>D</kbd>  
выберите, какого клиента отключить. 
* <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>r</kbd>  
обновите клиентский терминал. 

Чтобы прочитать весь список команд, обратитесь к странице руководства.


## Копирование и вставка: режим прокрутки

`tmux` имеет режим копирования такой же, как и `screen` (не забудьте использовать префикс команды `tmux`, а не `screen`!). Единственное отличие состоит в том, что вы используете команду <kbd>Ctrl</kbd>+<kbd>Пробел</kbd>, чтобы отметить начало выделения, и <kbd>Alt</kbd>+<kbd>w</kbd>, чтобы скопировать выделенный текст.

## Настройка `tmux`

Файлы конфигурации `tmux` обычно находятся в `/etc/tmux.conf` и `~/.tmux.conf`. При запуске `tmux` использует эти файлы, если они существуют. Также существует возможность запуска `tmux` с ключом `-f` для предоставления альтернативного файла конфигурации. Вы можете найти пример файла конфигурации `tmux`, который находится в `/usr/share/doc/tmux/example_tmux.conf`. Уровень настроек, которого вы можете достичь, действительно высок. Вот некоторые из вещей, которые вы можете сделать:
* Изменить префиксный ключ
```console
# Change the prefix key to C-a
set -g prefix C-a
unbind C-b
bind C-a send-prefix
```
* Установить дополнительные привязки клавиш для окон больше 9
```console
# Some extra key bindings to select higher numbered windows
bind F1 selectw -t:10
bind F2 selectw -t:11
bind F3 selectw -t:12
```

Чтобы получить полный список всех привязок, введите <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>?</kbd> (нажмите <kbd>q</kbd> для выхода) или обратитесь к странице руководства.


# Упражнения для закрепления

1. Укажите, соответствуют ли следующие операторы/функции GNU Screen, tmux или обоим:

| Функция/Оператор              | GNU Screen  | tmux          |
|:------------------------------|-------------|---------------|
| Префикс команды по умолчанию <kbd>Ctrl</kbd>+<kbd>a</kbd>  |
| Модель клиент-сервер          |           
| Панели это псевдотерминалы    |        
| Завершение области не уничтожает связанные с ней окна  |
| Сеансы включают окна          |       
| Сессии могут быть отключены   |         

2. Установите GNU Screen на свой компьютер (имя пакета: `screen`) и выполните следующие задачи: 
* Запустить программу. Какую команду вы используете? 
```
```
* Запустите `top`: 
```
```
* Используя префикс команд `screen`, откройте новое окно; затем откройте `/etc/screenrc` с помощью `vi`: 
```
```
* Перечислите окна внизу экрана: 
```
```
* Измените имя текущего окна на `vi`: 
```
```
* Измените название оставшегося окна на `top`. Для этого сначала отобразите список всех окон, чтобы вы могли перемещаться вверх и вниз и выбирать нужное: 
```
```
* Убедитесь, что имена изменились, снова отобразив имена окон в нижней части экрана: 
```
```
* Теперь отключитесь от сессии и при помощи `screen` создайте новую с именем `ssh`: 
```
```
* Отключитесь также от `ssh` и отобразите на экране список сессий: 
```
```
* Теперь подключитесь к первой сессии, используя его PID: 
```
```
* Вы должны снова оказаться в верхней части окна. Разделите окно по горизонтали и перейдите в новую пустую область: 
```
```
* Отобразите список всех окон на экране и выберите `vi`, который будет отображаться в новой пустой области: 
```
```
* Теперь разделите текущую область по вертикали, перейдите во вновь созданную пустую область и свяжите ее с совершенно новым окном: 
```
```
* Завершить все области, кроме текущей (помните, что, хотя вы завершаете области, их окна все еще продолжают работать). Затем выйдите из всех окон текущей сессии, пока сама сессия не будет завершена: 
```
```
* Наконец, еще раз просмотрите список своих сессий на экране, завершите оставшуюся сессию `ssh` по `PID` и убедитесь, что на самом деле сессий не осталось:
```
```
3. Установите `tmux` на свой компьютер (имя пакета: `tmux`) и выполните следующие задачи: 
* Запустить программу. Какую команду вы используете? 
```
```
* Запустите `top` (обратите внимание, как через пару секунд название окна в строке состояния изменится на `top`): 
```
```
* Используя префикс ключа `tmux`, откройте новое окно; 
```
```
* затем создайте `~/.tmux.conf` с помощью `nano`: 
```
```
* Разделите окно по вертикали и уменьшите размер вновь созданной панели в несколько раз: 
```
```
* Теперь измените имя текущего окна на `text editing`; затем пусть `tmux` отобразит список со всеми своими сессиями: 
```
```
* Перейти к окну, запущенному сверху, и вернуться к текущему, используя ту же комбинацию клавиш: 
```
```
* Отключитесь от текущей сессии и создайте новую с именем `ssh` и именем окна `ssh window`: 
```
```
* Отключитесь также от сессии `ssh` и `tmux` снова отобразит список сессий: 
```
```
>С этого момента упражнение требует, чтобы вы использовали удаленную машину для `ssh`-соединений с вашим локальным хостом (виртуальная машина вполне допустима и может оказаться действительно практичной). Убедитесь, что у вас установлен и запущен `openssh-server` на вашем локальном компьютере, и что хотя бы `openssh-client` установлен на удаленном компьютере. Теперь запустите удаленный компьютер и подключитесь через `ssh` к локальному хосту. 

* Как только соединение будет установлено, проверьте наличие сессий `tmux`: 
```
```
* На удаленном хосте подключитесь к сеансу `ssh` по имени: 
```
```
* Вернувшись на локальный компьютер, подключитесь к сеансу `ssh` по имени, убедившись, что соединение с удаленным хостом сначала разорвано: 
```
```
* Отображение всех сеансов для выбора и переход к первому сеансу (`[0]`). 
```
```
* Оказавшись там, завершите сессию `ssh` по имени: 
```
```
* Наконец, отключитесь от текущей сесии и завершите его по имени:
```
```

# Упражнения на размышление

1. И `screen`, и `tmux` могут войти в режим командной строки через командный префикс+<kbd>:</kbd> (мы уже видели краткий пример с `tmux`). Проведите небольшое исследование и выполните следующие задачи в режиме командной строки: 
* Перевести экран в режим копирования: 
```
```
* Заставьте `tmux` переименовать текущее окно: 
```
```
* Заставьте экран закрыть все окна и завершить сессию: 
```
```
* Сделайте так, чтобы `tmux` разделил панель на две части: 
```
```
* Заставить `tmux` завершить текущее окно:
```
```
2. Когда вы входите в режим копирования `screen`, вы можете не только использовать клавиши со стрелками и <kbd>PgUP</kbd> или <kbd>PgDown</kbd>, чтобы перемещаться по текущему окну и буферу прокрутки. Также существует возможность использования полноэкранного редактора в стиле `vi`. Используя этот редактор, выполните следующие задачи: 
* Отправьте `supercalifragilisticexpialidocious` в ваш `screen` терминал: 
```
```
* Теперь скопируйте последовательно идущих 5 символов(слева направо) в строку прямо над курсором: 
```
```
* Наконец, вставьте выделенное (`stice`) обратно в командную строку:
```
```
3. Предположим, вы хотите поделиться сеансом `tmux` (`our_session`) с другим пользователем. Вы создали сокет (`/tmp/our_socket`) с нужными правами доступа, чтобы и вы, и другие пользователь могли читать и писать в него. Какие еще два условия должны быть выполнены, чтобы второй пользователь мог успешно подключиться к сеансу через `tmux -S /tmp/our_socket a -t our_session`?
```
```


# Резюме

В этом уроке вы узнали о *терминальных мультиплексорах* в целом и о GNU Screen и `tmux` в частности. Важные понятия, которые следует запомнить, включают: 
* Префикс команды: `screen` использует <kbd>Ctrl</kbd>+<kbd>a</kbd>+<kbd>символ</kbd>; `tmux` <kbd>Ctrl</kbd>+<kbd>b</kbd>+<kbd>символ</kbd>. 
* Структура сессий, окон и оконных областей(регионов или панелей). 
* Режим копирования. 
* Отключение сессий: одна из самых мощных функций мультиплексоров. 

Команды, используемые в этом уроке:

`screen`
- [ ] Запускает сессию `screen`.

`tmux`
- [ ] Запускает сессию `tmux`.


# Ответы на упражнения для закрепления

1. Укажите, соответствуют ли следующие операторы/функции GNU Screen, tmux или обоим:

| Функция/Оператор                                          | GNU Screen | tmux       |
|:----------------------------------------------------------|:----------:|:----------:|
| Префикс команд по умолчанию <kbd>Ctrl</kbd>+<kbd>a</kbd>  |     X      |            |
| Модель клиент-сервер                                      |            |      X     |
| Панели это псевдотерминалы                                |            |      X     |        
| Завершение области не уничтожает связанные с ней окна     |     X      |            |
| Сеансы включают окна                                      |     X      |      X     |       
| Сессии могут быть отключены                               |     X      |      X     |         

2. Установите GNU Screen на свой компьютер(имя пакета: `screen`) и выполните следующие задачи: 
* Запустить программу. Какую команду вы используете?  
`screen`

* Запустите `top`:  
`top`

* Используя префикс команд `screen`, откройте новое окно; затем откройте `/etc/screenrc` с помощью `vi`:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>c</kbd>  
`vi /etc/screenrc`

* Перечислите окна внизу экрана:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>w</kbd>

* Измените имя текущего окна на `vi`:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>A</kbd>. Затем мы должны набрать `vi` и нажать <kbd>Enter</kbd>.

* Измените название оставшегося окна на `top`. Для этого сначала отобразите список всех окон, чтобы вы могли перемещаться вверх и вниз и выбирать нужное:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>"</kbd>  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>A</kbd>. Затем мы должны набрать `topi` и нажать <kbd>Enter</kbd>.

* Убедитесь, что имена изменились, снова отобразив имена окон в нижней части экрана:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>w</kbd>

* Теперь отключитесь от сессии и при помощи `screen` создайте новую с именем `ssh`:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>d</kbd>  
`screen -S "ssh"`

* Отключитесь также от `ssh` и отобразите на экране список сессий:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>d</kbd>  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>w</kbd>

* Теперь подключитесь к первой сессии, используя его PID:  
`screen -r PID-OF-SESSION`

* Вы должны снова вернуться в окно отображающее `top`. Разделите окно по горизонтали и перейдите в новую пустую область:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>S</kbd>  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>TAB</kbd>

* Отобразите список всех окон на экране и выберите `vi`, который будет отображаться в новой пустой области:  
Используйте <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>"</kbd>, чтобы отобразить список всех окон, выберите `vi` и нажмите <kbd>Enter</kbd>.

* Теперь разделите текущую область по вертикали, перейдите во вновь созданную пустую область и свяжите ее с совершенно новым окном:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>|</kbd>  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>TAB</kbd>  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>c</kbd>

* Завершить все области, кроме текущей(помните, что, хотя завершая области, их окна все еще продолжат работать). Затем выйдите из всех окон текущей сессии, пока сама сессия не будет завершена:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>Q</kbd>  
`exit`(to exit Bash).  
<kbd>Shift</kbd>+<kbd>:</kbd>, затем набираем `quit` и нажимаем <kbd>Enter</kbd>(чтобы выйти из `vi`). После этого мы набираем `exit`(чтобы выйти из базовой оболочки `Bash`) `q`(чтобы завершить `top`); затем мы набираем `exit`(чтобы выйти из базовой оболочки `Bash`).

* Наконец, еще раз просмотрите список сессий `screen` , завершите оставшуюся сессию `ssh` по `PID` и убедитесь, что на самом деле сессий не осталось:  
`screen -list` or `screen -ls`  
`screen -S PID-OF-SESSION -X quit`  
`screen -list` or `screen -ls`

3. Установите `tmux` на свой компьютер (имя пакета: `tmux`) и выполните следующие задачи:
* Запустить программу. Какую команду вы используете?  
`tmux`

* Запустите `top`(обратите внимание, как через пару секунд название окна в строке состояния изменится на `top`):  
`top`

* Используя префикс ключа `tmux`, откройте новое окно; затем создайте `~/.tmux.conf` с помощью `nano`:  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>c</kbd>  
`nano ~/.tmux.conf`

* Разделите окно по вертикали и уменьшите размер вновь созданной панели в несколько раз:  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>%</kbd>  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>Ctrl</kbd>+<kbd>↓</kbd>

* Теперь измените имя текущего окна на `text editing`; затем пусть `tmux` отобразит список со всеми своими сессиями:  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>,</kbd>. Затем мы вводим новое имя и нажимаем <kbd>Enter</kbd>.  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>s</kbd> или `tmux ls`.

* Перейти к окну, в котором запущен `top`, и вернуться к текущему, используя ту же комбинацию клавиш:  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>n</kbd> или <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>p</kbd>

* Отключитесь от текущей сессии и создайте новую с именем `ssh` и именем окна `ssh window`:  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>d</kbd>. `tmux new -s "ssh" -n "ssh window"`

* Отключитесь также от сессии `ssh`, а также при помощи `tmux` снова отобразите список сессий:  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>d</kbd>  
`tmux ls`

* Теперь запустите удаленную машину и подключитесь через `ssh` к локальному хосту. Как только соединение будет установлено, проверьте наличие сессий `tmux`:  
На удаленном хосте: `ssh local-username@local-ipaddress`. `tmux ls`

* На удаленном хосте подключитесь к сеансу `ssh` по имени:  
`tmux a -t ssh` (`a` можно заменить на `at` или `attach`).

* Вернувшись на локальный компьютер, подключитесь к сеансу `ssh` по имени, убедившись, что соединение с удаленным хостом сначала разорвано:  
`tmux a -t -d ssh`(`a` можно заменить на `at` или `attach`).

* Отобразите список всех сеансов для выбора и перейдите к вашему первому сеансу(`[0]`). Оказавшись там, завершите сессию `ssh` по имени:  
Мы набираем <kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>s</kbd>, используем клавиши со стрелками, чтобы отметить сессию `0`, и нажимаем <kbd>Enter</kbd>  
`tmux kill-session -t ssh`.

* Наконец, отключитесь от текущей сесии и завершите его по имени:  
<kbd>Ctrl</kbd>+<kbd>b</kbd>-<kbd>d</kbd>
`tmux kill-session -t ssh`.


# Ответы на упражнения для размышления

1. И `screen`, и `tmux` могут войти в режим командной строки через командный префикс+<kbd>:</kbd> (мы уже видели краткий пример с `tmux`). Проведите небольшое исследование и выполните следующие задачи в режиме командной строки: 
* Перевести `screen` в режим копирования:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>:</kbd> - Затем мы набираем `copy`.

* Заставьте `tmux` переименовать текущее окно:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>:</kbd> - Затем мы набираем `rename-window`.

* Заставьте экран закрыть все окна и завершить сессию:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>:</kbd> - Затем мы набираем `quit`.

* Сделайте так, чтобы `tmux` разделил панель на две части:  
<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>:</kbd> - Затем мы набираем `split-window`.

* Заставить `tmux` завершить текущее окно:  

	<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>:</kbd> - Затем мы набираем `kill-window`.

2. Когда вы входите в режим копирования `screen`, вы можете не только использовать клавиши со стрелками и <kbd>PgUP</kbd> или <kbd>PgDown</kbd>, чтобы перемещаться по текущему окну и буферу прокрутки. Также существует возможность использования полноэкранного редактора в стиле `vi`. Используя этот редактор, выполните следующие задачи: 
* Отправьте `supercalifragilisticexpialidocious` в ваш `screen` терминал:  

	`echo supercalifragilisticexpialidocious`

* Теперь скопируйте последовательно идущих 5 символов(слева направо) в строку прямо над курсором:  

	Входим в режим копирования: <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>[</kbd> или <kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>:</kbd> и затем набираем `copy`. Затем мы переходим к строке выше, используя `k`, и нажимаем <kbd>Пробел</kbd>, чтобы отметить начало выделения. Наконец, мы перемещаемся вперед на четыре символа с помощью `l` и снова нажимаем <kbd>Пробел</kbd>, чтобы отметить конец выделения.

* Наконец, вставьте выделенное (`stice`) обратно в командную строку:  

	<kbd>Ctrl</kbd>+<kbd>a</kbd>-<kbd>]</kbd>

3. Предположим, вы хотите поделиться сеансом `tmux` (`our_session`) с другим пользователем. Вы создали сокет (`/tmp/our_socket`) с нужными правами доступа, чтобы и вы, и другие пользователь могли читать и писать в него. Какие еще два условия должны быть выполнены, чтобы второй пользователь мог успешно подключиться к сеансу через `tmux -S /tmp/our_socket a -t our_session`?

	У обоих пользователей должна быть общая группа, например `multiplexer`. Затем мы должны изменить сокет в эту группу: `chgrp multiplexer / tmp / our_socket`.
