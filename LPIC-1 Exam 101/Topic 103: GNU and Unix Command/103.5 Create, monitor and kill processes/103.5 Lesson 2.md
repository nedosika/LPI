# 103.5 Урок 1

| Сертификат:   | LPIC-1                                      |
|:--------------|:--------------------------------------------|
| Версия:       | 5.0                                         |
| Тема:         | 103 GNU и Unix комманды                     |                           
| Цель:         | 103.5 Создание, мониторинг и завершение процессов |
| Урок:         | 2 из 2                                      |


# Введение

Инструменты и утилиты, рассмотренные в предыдущем уроке, очень полезны для мониторинга процессов в целом. Однако системному администратору, возможно, придется пойти еще дальше. В этом уроке мы обсудим концепцию терминальных мультиплексоров и узнаем о *GNU Screen* и *tmux*, поскольку, несмотря на современные и прекрасные терминальные эмуляторы, мультиплексоры по-прежнему сохраняют некоторые интересные, мощные функции для продвинутого системного администратора.


# Особенности терминальных мультиплексоров

В электронике мультиплексор (или `mux`) - это устройство, которое позволяет подключать несколько входов к одному выходу. Таким образом, оконечный мультиплексор дает нам возможность переключаться между различными входами по мере необходимости. Хотя это и не совсем то же самое, но экран и `tmux` имеют ряд общих функций: 

* Любой успешный вызов приведет как минимум к сеансу, который, в свою очередь, будет включать как минимум окно. Окна содержат программы. 
* Окна можно разделить на области или панели, что может повысить производительность при одновременной работе с различными программами. 
* Легкость управления: для запуска большинства команд используется комбинация клавиш - так называемый префикс команды или командная клавиша - за которым следует другой символ. 
* Сеансы можно отключать от текущего терминала (то есть программы отправляются в фоновый режим и продолжают работать). Это гарантирует полное выполнение программ, независимо от закрытия терминала, зависания или потери удаленного соединения. 
* Подключение к сокету. 
* Режим копирования. 
* Они легко настраиваются.


# GNU Screen

В ранние годы Unix (1970-1980-е) компьютеры в основном состояли из терминалов, подключенных к центральному компьютеру. Это все, никаких окон или вкладок. И это стало причиной создания *GNU Screen* в 1987 году: эмуляция нескольких независимых *VT100 экранов* на одном физическом терминале.


# Окна

GNU Screen вызывается простым вводом `screen` в терминал. Сначала вы увидите приветственное сообщение:
```
GNU Screen version 4.05.00 (GNU) 10-Dec-16

Copyright (c) 2010 Juergen Weigert, Sadrul Habib Chowdhury
Copyright (c) 2008, 2009 Juergen Weigert, Michael Schroeder, Micah Cowan, Sadrul Habib Chowdhury
Copyright (c) 1993-2002, 2003, 2005, 2006, 2007 Juergen Weigert, Michael Schroeder
Copyright (c) 1987 Oliver Laumann
(...)
```
Нажмите пробел или Enter, чтобы закрыть сообщение, и вам будет показана командная строка:
```
$
```
Может показаться, что ничего не произошло, но факт в том, что `screen` уже создал и управляет своим первым сеансом и окном. Префикс команды экрана - `Ctrl`+`a`. Чтобы увидеть все окна в нижней части дисплея терминала, введите `Ctrl`+`a-w`:
```
0*$ bash
```
Вот оно, наше пока единственное окно! Обратите внимание, что счет начинается с `0`. Чтобы создать другое окно, введите `Ctrl`+`a-c`. Вы увидите новую подсказку. Давайте запустим `ps` в этом новом окне:
```
$ ps
  PID TTY          TIME CMD
  974 pts/2    00:00:00 bash
  981 pts/2    00:00:00 ps
```
и снова введите `Ctrl`+`a-w`:
```
0-$ bash  1*$ bash
```
Здесь у нас есть два окна (обратите внимание на звездочку, указывающую на то, что отображается в данный момент). Однако, поскольку они были начаты с Bash, им обоим дано одно и то же имя. Поскольку мы вызвали `ps` в нашем текущем окне, давайте переименуем его с тем же именем. Для этого вам нужно набрать `Ctrl`+`a-A` и при появлении запроса написать новое имя окна (`ps`):
```
Set window's title to: ps
```
Теперь давайте создадим еще одно окно, но с самого начала дадим ему имя: `yetanotherwindow`. Это делается путем вызова `screen` с ключом `-t`:
```
$ screen -t yetanotherwindow
```
Перемещаться между окнами можно разными способами: 
* Используя `Ctrl`+`a-n` (перейти к следующему окну) и `Ctrl`+`a-p` (перейти к предыдущему окну). 
* Используя `Ctrl`+`a-номер` (перейти к номеру окна). Используя `Ctrl`+`a-"`, чтобы увидеть список всех окон. 
* Вы можете перемещаться вверх и вниз с помощью клавиш со стрелками и выбрать то, которое вы хотите, с помощью Enter:
```
Num Name                                                Flags

   0 bash                                                   $
   1 ps                                                     $
   2 yetanotherwindow
```
При работе с окнами важно помнить следующее: окна запускают свои программы совершенно независимо друг от друга. Программы будут продолжать работать, даже если их окно не отображается (также, когда сеанс экрана отключен, как мы вскоре увидим). Чтобы удалить окно, просто завершите программу, работающую в нем (как только последнее окно будет удалено, `screen` завершит свою работу). Или используйте `Ctrl`+`a-k` в окне, которое вы хотите удалить; вас попросят подтвердить:
```
Really kill this window [y/n]

Window 0 (bash) killed.
```


# Области (Regions)

`screen` может разделить экран терминала на несколько областей для размещения окон. Это разделение может быть горизонтальным (`Ctrl`+`a-S`) или вертикальным (`Ctrl`+`a-|`). Единственное, что будет отображаться в новом регионе, это  `--` внизу, что означает, что он пуст:
```
1 ps                                                               --
```
Чтобы перейти в новую область, введите `Ctrl`+`a-Tab`. Теперь вы можете добавить окно любым из методов, которые мы уже видели, например: `Ctrl`+`a-2`. Теперь `--` должно было превратиться в `2 yetanotherwindow`:
```
$ ps                                                  $
  PID TTY          TIME CMD
 1020 pts/2    00:00:00 bash
 1033 pts/2    00:00:00 ps
$ screen -t yetanotherwindow




   1 ps                                                                2 yetanotherwindow
```
При работе с областями следует учитывать следующие важные аспекты: 
* Вы перемещаетесь между областями, нажимая `Ctrl`+`a-Tab`. 
* Вы можете завершить все области, кроме текущего, с помощью `Ctrl`+`a-Q`. Вы можете завершить текущую область с помощью `Ctrl`+`a-X`. 
* Завершение области не завершает связанное с ней окно.


# Сессии

До сих пор мы играли с несколькими окнами и областями, но все они принадлежали одной и той же сессии. Пора начать играть с сессиями. Чтобы увидеть список всех сеансов, введите `screen -list` или `screen -ls`:
```
$ screen -list
There is a screen on:
        1037.pts-0.debian       (08/24/19 13:53:35)     (Attached)
1 Socket in /run/screen/S-carol.
```
На данный момент это наша единственная сессия: 
* `PID`   
1037 
* `Name`  
pts-0.debian (с указанием терминала - в нашем случае подчиненного псевдотерминала - и имени хоста). 
`Status`  
`Attached` 

Давайте создадим новый сеанс, дав ему более описательное имя:
```
$ screen -S "second session"
```
Дисплей терминала очистится, и вам будет предложено новое приглашение. Вы можете проверить наличие сеансов еще раз:
```
$ screen -ls
There are screens on:
        1090.second session     (08/24/19 14:38:35)     (Attached)
        1037.pts-0.debian       (08/24/19 13:53:36)     (Attached)
2 Sockets in /run/screen/S-carol.
```
Чтобы завершить сеанс, закройте все его окна или просто введите команду `screen -S SESSION-PID -X quit` (вместо этого вы также можете указать имя сеанса). Избавимся от нашей первой сессии:
```
$ screen -S 1037 -X quit
```
Вы будете отправлены обратно в окно терминала за пределами экрана. Но помните, что наша вторая сессия все еще жива:
```
$ screen -ls
There is a screen on:
	1090.second session	(08/24/19 14:38:35)	(Detached)
1 Socket in /run/screen/S-carol.
```
Однако, поскольку мы уничтожили его родительский сеанс, ему присвоен новый ярлык: `Detached`.


## Отключенный сеанс

По ряду причин вы можете захотеть отсоединить сеанс от его терминала: 
* Чтобы позволить вашему компьютеру на работе делать свои дела и подключаться удаленно позже из дома. 
* Чтобы поделиться сеансом с другими пользователями. 

Вы отключаете сеанс с помощью комбинации клавиш `Ctrl`+`a-d`. Вы вернетесь в свой терминал:
