# 104.2 Урок 1

| Сертификат:   | LPIC-1                                      |
|:--------------|:--------------------------------------------|
| Версия:       | 5.0                                         |
| Тема:         | 104 устройства, файловые системы Linux, стандарт иерархии файловых систем |                           
| Цель:         | 104.1 Поддержание целостности файловых систем|
| Урок:         | 1 из 1                                      |


# Введение

Cовременные файловые системы Linux журналируемые. Это означает, что каждая операция перед выполнением регистрируется во внутреннем логе (the *journal*). Если операция прервана из-за системной ошибки (например, kernel panic, сбоя питания и т. д.), Ее можно восстановить, проверив журнал, чтобы избежать повреждения файловой системы и потери данных.

Это значительно снижает потребность в ручных проверках файловой системы, но они все равно могут понадобиться. Знание используемых для этого инструментов (и соответствующих параметров) может показать разницу между ужином дома с семьей или ночевкой в серверной на работе.

В этом уроке мы обсудим инструменты, доступные для мониторинга использования файловой системы, оптимизации ее работы, а также способы проверки и устранения повреждений.


# Проверка использования диска

Есть две команды, которые можно использовать для проверки того, сколько места используется и сколько осталось в файловой системе. Первый - `du`, что означает «disk usage»(использоваие диска).

`du` рекурсивен по своей природе. В своей самой простой форме команда просто покажет, сколько блоков размером 1 килобайт используется текущим каталогом и всеми его подкаталогами:
```
$ du
4816	.
```
Это не очень полезно, поэтому мы можем запросить более «удобочитаемый» вывод, добавив параметр `-h`:
```
$ du -h
4.8M	.
```
По умолчанию du показывает только счетчик использования каталогов (учитывая все файлы и подкаталоги внутри него). Чтобы показать индивидуальный счетчик для всех файлов в каталоге, используйте параметр `-a`:
```
$ du -ah
432K	./geminoid.jpg
508K	./Linear_B_Hero.jpg
468K	./LG-G8S-ThinQ-Mirror-White.jpg
656K	./LG-G8S-ThinQ-Range.jpg
60K	./Stranger3_Titulo.png
108K	./Baidu_Banho.jpg
324K	./Xiaomi_Mimoji.png
284K	./Mi_CC_9e.jpg
96K	./Mimoji_Comparativo.jpg
32K	./Xiaomi FCC.jpg
484K	./geminoid2.jpg
108K	./Mimoji_Abre.jpg
88K	./Mi8_Hero.jpg
832K	./Tablet_Linear_B.jpg
332K	./Mimoji_Comparativo.png
4.8M	.
```
Поведение по умолчанию - показать использование каждого подкаталога, а затем общее использование текущего каталога, включая подкаталоги:
```
$ du -h
4.8M	./Temp
6.0M	.
```
В приведенном выше примере мы видим, что подкаталог `Temp` занимает 4,8 МБ, а текущий каталог, *включая* `Temp`, занимает 6,0 МБ. Но сколько места занимают *файлы* в текущем каталоге, исключая подкаталоги? Для этого у нас есть параметр `-S`:
```
$ du -Sh
4.8M	./Temp
1.3M	.
```
>Помните, что параметры командной строки чувствительны к регистру: `-s` отличается от `-S`.

Если вы хотите сохранить это различие между пространством, используемым файлами в текущем каталоге, и пространством, используемым подкаталогами, но `также` хотите получить общий итог в конце, вы можете добавить параметр `-c`:
```
$ du -Shc
4.8M	./Temp
1.3M	.
6.0M	total
```
Вы можете контролировать, насколько «глубоким» должен быть вывод du с помощью параметра `-d N`, где `N` описывает уровни. Например, если вы используете параметр `-d 1`, он покажет текущий каталог и его подкаталоги, но не их подкаталоги.

Смотрите разницу ниже. Без `-d`:
```
$ du -h
216K	./somedir/anotherdir
224K	./somedir
232K	.
```
И ограничиваем глубину одним уровнем с помощью `-d 1`:
```
$ du -h -d1
224K	./somedir
232K	.
```
Обратите внимание, что даже если другой каталог не отображается, его размер все равно учитывается.

Вы можете исключить некоторые типы файлов из подсчета, что вы можете сделать с помощью `--exclude = "PATTERN"`, где `PATTERN` - это шаблон, с которым вы хотите сопоставить. Рассмотрим этот каталог:
```
$ du -ah
124K	./ASM68K.EXE
2.0M	./Contra.bin
36K	./fixheadr.exe
4.0K	./README.txt
2.1M	./Contra_NEW.bin
4.0K	./Built.bat
8.0K	./Contra_Main.asm
4.2M	.
```
Теперь мы будем использовать `--exclude`, чтобы отфильтровать каждый файл с расширением `.bin`:
```
$ du -ah --exclude="*.bin"
124K	./ASM68K.EXE
36K	./fixheadr.exe
4.0K	./README.txt
4.0K	./Built.bat
8.0K	./Contra_Main.asm
180K	.
```

Обратите внимание, что общая сумма больше не отражает размер исключенных файлов.


# Проверка свободного места

`du` работает на уровне файлов. Есть еще одна команда, которая может показать вам использование диска и сколько места доступно на уровне файловой системы. Это команда `df`.

Команда `df` предоставит список всех доступных (уже смонтированных) файловых систем в вашей системе, включая их общий размер, сколько места было использовано, сколько места доступно, процент использования и место монтирования:
```
$ df
Filesystem     1K-blocks      Used Available Use% Mounted on
udev             2943068         0   2943068   0% /dev
tmpfs             595892      2496    593396   1% /run
/dev/sda1      110722904  25600600  79454800  25% /
tmpfs            2979440    951208   2028232  32% /dev/shm
tmpfs               5120         0      5120   0% /run/lock
tmpfs            2979440         0   2979440   0% /sys/fs/cgroup
tmpfs             595888        24    595864   1% /run/user/119
tmpfs             595888       116    595772   1% /run/user/1000
/dev/sdb1          89111      1550     80824   2% /media/carol/part1
/dev/sdb3          83187      1550     75330   3% /media/carol/part3
/dev/sdb2          90827      1921     82045   3% /media/carol/part2
/dev/sdc1      312570036 233740356  78829680  75% /media/carol/Samsung Externo
```
Однако показывать размер блоками по 1 КБ не очень удобно. Как и в случае с `du`, вы можете добавить параметры `-h`, чтобы получить более «удобочитаемый» вывод:
```
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            2.9G     0  2.9G   0% /dev
tmpfs           582M  2.5M  580M   1% /run
/dev/sda1       106G   25G   76G  25% /
tmpfs           2.9G  930M  2.0G  32% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           2.9G     0  2.9G   0% /sys/fs/cgroup
tmpfs           582M   24K  582M   1% /run/user/119
tmpfs           582M  116K  582M   1% /run/user/1000
/dev/sdb1        88M  1.6M   79M   2% /media/carol/part1
/dev/sdb3        82M  1.6M   74M   3% /media/carol/part3
/dev/sdb2        89M  1.9M   81M   3% /media/carol/part2
/dev/sdc1       299G  223G   76G  75% /media/carol/Samsung Externo
```
Вы также можете использовать параметр `-i` для отображения используемых / доступных inode вместо блоков:
```
$ df -i
Filesystem      Inodes  IUsed   IFree IUse% Mounted on
udev            737142    547  736595    1% /dev
tmpfs           745218    908  744310    1% /run
/dev/sda6      6766592 307153 6459439    5% /
tmpfs           745218    215  745003    1% /dev/shm
tmpfs           745218      4  745214    1% /run/lock
tmpfs           745218     18  745200    1% /sys/fs/cgroup
/dev/sda1        62464    355   62109    1% /boot
tmpfs           745218     43  745175    1% /run/user/1000
```
Одним из полезных параметров является `-T`, который также выводит тип каждой файловой системы:
```
$ df -hT
Filesystem     Type      Size  Used Avail Use% Mounted on
udev           devtmpfs  2.9G     0  2.9G   0% /dev
tmpfs          tmpfs     582M  2.5M  580M   1% /run
/dev/sda1      ext4      106G   25G   76G  25% /
tmpfs          tmpfs     2.9G  930M  2.0G  32% /dev/shm
tmpfs          tmpfs     5.0M     0  5.0M   0% /run/lock
tmpfs          tmpfs     2.9G     0  2.9G   0% /sys/fs/cgroup
tmpfs          tmpfs     582M   24K  582M   1% /run/user/119
tmpfs          tmpfs     582M  116K  582M   1% /run/user/1000
/dev/sdb1      ext4       88M  1.6M   79M   2% /media/carol/part1
/dev/sdb3      ext4       82M  1.6M   74M   3% /media/carol/part3
/dev/sdb2      ext4       89M  1.9M   81M   3% /media/carol/part2
/dev/sdc1      fuseblk   299G  223G   76G  75% /media/carol/Samsung Externo
```
Зная тип файловой системы, вы можете фильтровать вывод. Вы можете показать только файловые системы заданного типа с помощью -`t TYPE` или исключить файловые системы заданного типа с помощью `-x TYPE`, как в примерах ниже. 

Исключая файловые системы `tmpfs`:
```
$ df -hx tmpfs
Filesystem      Size  Used Avail Use% Mounted on
udev            2.9G     0  2.9G   0% /dev
/dev/sda1       106G   25G   76G  25% /
/dev/sdb1        88M  1.6M   79M   2% /media/carol/part1
/dev/sdb3        82M  1.6M   74M   3% /media/carol/part3
/dev/sdb2        89M  1.9M   81M   3% /media/carol/part2
/dev/sdc1       299G  223G   76G  75% /media/carol/Samsung Externo
```
Показаны только файловые системы `ext4`:
```
$ df -ht ext4
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       106G   25G   76G  25% /
/dev/sdb1        88M  1.6M   79M   2% /media/carol/part1
/dev/sdb3        82M  1.6M   74M   3% /media/carol/part3
/dev/sdb2        89M  1.9M   81M   3% /media/carol/part2
```
Вы также можете настроить вывод `df`, выбрав, что должно отображаться и в каком порядке, используя параметр `--output =`, за которым следует список полей, которые вы хотите отображать, через запятую. Некоторые из доступных полей:

`source` - Устройство, соответствующее файловой системе.

`fstype` - Тип файловой системы.

`size` - Общий размер файловой системы.

`used` - Сколько места используется.

`avail` - Сколько места доступно.

`pcent` - Процент использования.

`target` - Где смонтирована файловая система (точка монтирования).

Если вам нужен вывод, показывающий цель, источник, тип и использование, вы можете использовать:
```
$ df -h --output=target,source,fstype,pcent
Mounted on                    Filesystem     Type     Use%
/dev                          udev           devtmpfs   0%
/run                          tmpfs          tmpfs      1%
/                             /dev/sda1      ext4      25%
/dev/shm                      tmpfs          tmpfs     32%
/run/lock                     tmpfs          tmpfs      0%
/sys/fs/cgroup                tmpfs          tmpfs      0%
/run/user/119                 tmpfs          tmpfs      1%
/run/user/1000                tmpfs          tmpfs      1%
/media/carol/part1            /dev/sdb1      ext4       2%
/media/carol/part3            /dev/sdb3      ext4       3%
/media/carol/part2            /dev/sdb2      ext4       3%
/media/carol/Samsung Externo  /dev/sdc1      fuseblk   75%
```
`df` также можно использовать для проверки информации inode, передав следующие поля в `--output =`:

`itotal` - Общее количество индексных дескрипторов в файловой системе.

`iused` - Количество используемых inodes в файловой системе.

`iavail` - Количество доступных inodes в файловой системе.

`ipcent` - Процент используемых индексных дескрипторов в файловой системе.

Например:
```
$ df --output=source,fstype,itotal,iused,ipcent
Filesystem     Type      Inodes  IUsed IUse%
udev           devtmpfs  735764    593    1%
tmpfs          tmpfs     744858   1048    1%
/dev/sda1      ext4     7069696 318651    5%
tmpfs          tmpfs     744858    222    1%
tmpfs          tmpfs     744858      3    1%
tmpfs          tmpfs     744858     18    1%
tmpfs          tmpfs     744858     22    1%
tmpfs          tmpfs     744858     40    1%
```

# Поддержка файловых систем ext2, ext3 и ext4


