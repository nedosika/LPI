# 104.1 Урок 1

| Сертификат:   | LPIC-1                                      |
|:--------------|:--------------------------------------------|
| Версия:       | 5.0                                           |
| Тема:         | 104 Устройства, файловые системы Linux, стандарт иерархии файловых систем |                           
| Цель:         | 104.6 Создание и изменение жесткиих и символических ссылок |
| Урок:         | 1 из 1                                      |


# Введение

В Linux все обрабатывается как файл. Однако некоторые файлы обрабатываются особым образом либо из-за места, в котором они хранятся, например, временные файлы, либо из-за того, как они взаимодействуют с файловой системой, например, ссылки. В этом уроке вы узнаете, где находятся такие файлы, как они работают и как ими управлять.


# Временные файлы

Временные файлы - это файлы, используемые программами для хранения данных, которые необходимы только на короткое время. Это могут быть данные о запущенных процессах, журналы сбоев, временные файлы из автосохранения, промежуточные файлы, используемые во время преобразования файлов, файлы кеша и т. д.

## Расположение временных файлов

Версия 3.0 стандарта иерархии файловой системы (FHS) определяет стандартные расположения временных файлов в системах Linux. Каждое расположение имеет различное назначение и поведение, и разработчикам рекомендуется следовать соглашениям, установленным FHS, при записи временных данных на диск.

`/tmp`
>Согласно FHS, программы не должны предполагать, что файлы, записанные здесь, будут сохранены между вызовами программы. Рекомендуется очистить этот каталог (удалить все файлы) во время загрузки системы, хотя это не обязательно.

`/var/tmp`
>Другое место для временных файлов, но его не следует очищать во время загрузки системы. Файлы, хранящиеся здесь, обычно сохраняются между перезагрузками.

`/run`
>Этот каталог содержит данные переменных времени выполнения, используемые запущенными процессами, например файлы идентификаторов процессов (`.pid`). Программы, которым требуется более одного файла времени выполнения, могут создавать здесь подкаталоги. Это место необходимо очистить во время загрузки системы. Назначение этого каталога когда-то выполнялось `/var/run`, а в некоторых системах `/var/run` может быть символической ссылкой на `/run`.

## Права доступа на временные файлы

Наличие общесистемных временных каталогов в многопользовательской системе создает некоторые проблемы с правами доступа. На первый взгляд можно подумать, что такие каталоги будут «доступны для записи всем», то есть любой пользователь может записывать или удалять данные в них. Но если бы это было правдой, как вы могли бы предотвратить удаление или изменение пользователем файлов, созданных другим пользователем?

Решение - специальные права доступа, называемое липким битом, которое применяется только к каталогам. Когда этот специальный бит установлен для каталога, он запрещает пользователям удалять или переименовывать файл в этом каталоге, если они не являются владельцем файла.

Каталоги с установленным липким битом отображают `t` вместо `x` в правах доступа остальным пользователям в результате вывода команды `ls -l`. Например, давайте проверим права доступа для каталогов `/tmp` и `/var/tmp`:
```
$ ls -ldh /tmp/ /var/tmp/
drwxrwxrwt 25 root root 4,0K Jun  7 18:52 /tmp/
drwxrwxrwt 16 root root 4,0K Jun  7 09:15 /var/tmp/
```
Как вы можете видеть что `t` заменил `x` на правах доступа для остальных пользователей, в обоих каталогах установлен липкий бит.

Чтобы установить липкий бит в каталоге с помощью `chmod` в числовом режиме, используйте четырехзначную нотацию и `1` в качестве первой цифры. Например:
```
$ chmod 1755 temp
```
Это установит липкий бит для каталога с именем `temp` и права доступа `rwxr-xr-t`.

При использовании символьного режима используйте параметр `t`. Таким образом, `+t` можно использовать для установки липкого бита, а `-t` - для его снятия. Вот так:
```
$ chmod +t temp
```


# Понимание ссылок

Как уже говорилось ранее, в Linux все представлено в виде файла. Но есть файлы особого типа, называемые ссылками. В ОС Linux существуют два типа ссылок:


**Символические ссылки**

Также называемые *мягкими ссылками*, они указывают на путь к другому файлу. Если вы удалите файл, на который указывает ссылка (так называемую *цель*), ссылка все еще будет существовать, но она «перестанет работать», поскольку теперь указывает на «пустоту».

**Жесткие ссылки**

Думайте о жесткой ссылке как о втором имени исходного файла. Это не дубликаты, а дополнительная запись в файловой системе, указывающая на то же место (индексный дескриптор) на диске.
    
>*Inode* - это структура данных, в которой хранятся атрибуты объекта (например, файла или каталога) в файловой системе. Среди этих атрибутов - права доступа, владелец и блоки диска, на которых хранятся данные объекта. Думайте об этом как о записи в индексе, отсюда и название, которое происходит от «index node».

## Работа с жесткими ссылками
### Создание жестких ссылок

Команда для создания жесткой ссылки в Linux - `ln`. Основной синтаксис:
```
$ ln TARGET LINK_NAME
```
TARGET должна уже существовать (это файл, на который будет указывать ссылка), и если цель не находится в текущем каталоге или если вы хотите создать ссылку в другом месте, вы *должны* указать полный путь к ней. Например, команда:
```
$ ln target.txt /home/carol/Documents/hardlink
```
создаст файл с именем `hardlink` в каталоге`/home/carol/Documents/`, связанный с файлом `target.txt` в текущем каталоге.

Если вы не укажете последний параметр (`LINK_NAME`), в текущем каталоге будет создана ссылка с тем же именем, что и цель.

### Управление жесткими ссылками

Жесткие ссылки - это записи в файловой системе, которые имеют разные имена, но указывают на одни и те же данные на диске. Все такие имена равны и могут использоваться для обозначения файла. Если вы измените содержимое одного из имен, содержимое всех других имен, указывающих на этот файл, изменится, поскольку все эти имена указывают на одни и те же данные. Если вы удалите одно из имен, другие имена по-прежнему будут работать.

Это происходит потому, что когда вы «удаляете» файл, данные на самом деле не стираются с диска. Система просто удаляет запись в таблице файловой системы, указывающую на индексный дескриптор, соответствующий данным на диске. Но если у вас есть вторая запись, указывающая на тот же индексный дескриптор, вы все равно можете получить доступ к данным. Представьте себе это как две дороги, сходящиеся в одной точке. Даже если вы заблокируете или перенаправите одну из дорог, вы все равно сможете добраться до пункта назначения по другой.

Вы можете проверить это, используя параметр `-i` команды `ls`. Рассмотрим следующее содержимое каталога:
```
$ ls -li
total 224
3806696 -r--r--r-- 2 carol carol 111702 Jun  7 10:13 hardlink
3806696 -r--r--r-- 2 carol carol 111702 Jun  7 10:13 target.txt
```
Число перед разрешениями - это номер `inode`. Видите, что и жесткая ссылка на файл, и файл `target.txt` имеют одинаковый номер (`3806696`)? Это потому, что первый файл является жесткой ссылкой на другой.

Но какой из них оригинал, а какой - ссылка? Ответа на этот вопрос не существует, поскольку для всех практических задач они одинаковы. Обратите внимание, что каждая жесткая ссылка, указывающая на файл, увеличивает количество ссылок файла. Это число видно сразу после прав доступа к файлу в результате вывода команды `ls -l`. По умолчанию каждый файл имеет счетчик ссылок равный 1 (каталоги имеют счетчик равный 2), и каждая жесткая ссылка на него увеличивает счетчик на единицу. Вот почему количество ссылок на файлы в приведенном выше листинге равно 2.

В отличие от символических ссылок, вы можете создавать только жесткие ссылки на обычные файлы, и ссылка и цель должны находиться в одной файловой системе.

### Перемещение и удаление жестких ссылок

Поскольку жесткие ссылки обрабатываются как обычные файлы, их можно удалить с помощью `rm` и переименовать или перемещать по файловой системе с помощью `mv`. А поскольку жесткая ссылка указывает на тот же индекс целевого объекта, ее можно свободно перемещать, не опасаясь «разорвать» ссылку.

## Символические ссылки
### Создание символических ссылок

Команда, используемая для создания символической ссылки, тоже `ln`, но с добавленным параметром `-s`. Вот так:
```
$ ln -s target.txt /home/carol/Documents/softlink
```
Это создаст файл с именем `softlink` в каталоге `/home/carol/Documents/`, указывающий на файл `target.txt` в текущем каталоге.

Как и в случае жестких ссылок, вы можете опустить имя ссылки, чтобы создать ссылку с тем же именем, что и цель в текущем каталоге.

### Управление символическими ссылками

Символические ссылки указывают на другой путь в файловой системе. Вы можете создавать программные ссылки на файлы и каталоги даже на разных разделах. Определить символическую ссылку в выводе команды `ls` довольно просто:
```
$ ls -lh
total 112K
-rw-r--r-- 1 carol carol 110K Jun  7 10:13 target.txt
lrwxrwxrwx 1 carol carol   12 Jun  7 10:14 softlink -> target.txt
```
В приведенном выше примере первым символом разрешений для файловой `softlink` является `l`, что указывает на символьную ссылку. Кроме того, сразу после имени файла вы видите имя цели, на которую указывает ссылка, файл `target.txt`.

Обратите внимание, что в списках файлов и каталогов сами программные ссылки всегда показывают права доступа `rwx` для владельца, группы и остальных пользователей, но на практике права доступа для них такие же, как и для цели.

### Перемещение и удаление символических ссылок

Как и жесткие ссылки, символические ссылки можно удалить с помощью `rm` и переместить или переименовать с помощью `mv`. Однако при их создании следует проявлять особую осторожность, чтобы не «разорвать» ссылку, если она перемещается из исходного положения.

При создании символических ссылок вы должны знать, что, если путь не указан полностью, местоположение цели интерпретируется *относительно* местоположения ссылки. Это может создать проблемы при перемещении ссылки или файла, на который она указывает.

Это легче понять на примере. Допустим, у вас есть файл с именем `original.txt` в текущем каталоге, и вы хотите создать на него символическую ссылку под названием `softlink`. Вы можете использовать:
```
$ ln -s original.txt softlink
```
И, видимо, все будет хорошо. Давайте проверим с помощью `ls`:
```
$ ls -lh
total 112K
-r--r--r-- 1 carol carol 110K Jun  7 10:13 original.txt
lrwxrwxrwx 1 carol carol   12 Jun  7 19:23 softlink -> original.txt
```
Посмотрите, как построена ссылка: `softlink` указывает на (`→`) `original.txt`. Однако давайте посмотрим, что произойдет, если вы переместите ссылку в предыдущий каталог и попытаетесь отобразить его содержимое с помощью команды `less`:
```
$ mv softlink ../
$ less ../softlink
../softlink: No such file or directory
```
Поскольку путь к файлу `original.txt` не был указан, система предполагает, что он находится в том же каталоге, что и ссылка. Если это не так, ссылка перестает работать.

Способ предотвратить это - всегда указывать полный путь к цели при создании ссылки:
```
$ ln -s /home/carol/Documents/original.txt softlink
```
Таким образом, независимо от того, куда вы переместите ссылку, она все равно будет работать, потому что она указывает на абсолютное местоположение цели. Проверьте с помощью `ls`:
```
$ ls -lh
total 112K
lrwxrwxrwx 1 carol carol   40 Jun  7 19:34 softlink -> /home/carol/Documents/original.txt
```

# Упражнения для закрепления

1. Представьте, что программе нужно создать одноразовый временный файл, который больше никогда не понадобится после закрытия программы. В каком каталоге нужно создать этот файл?
2. Какой временный каталог необходимо очистить во время загрузки?
3. Какой параметр у `chmod` в *символьном* режиме позволяет активировать липкий бит в каталоге?
4. Представьте, что в каталоге `/home/carol/Documents` есть файл с именем `document.txt`. Какая команда создает символьную ссылку на него с именем `text.txt` в текущем каталоге? ln -s /home/carol/Documents/document.txt text.txt
5. Объясните разницу между жесткой ссылкой на файл и копией этого файла.


# Упражнения на размышления

1. Представьте, что внутри каталога вы создаете файл `recipes.txt`. Внутри этого каталога вы также создадите жесткую ссылку на этот файл с именем `receitas.txt` и символическую(*мягкую*) ссылку с именем `rezepte.txt`.
```
$ touch recipes.txt
$ ln recipes.txt receitas.txt
$ ln -s recipes.txt rezepte.txt
```
Содержимое каталога должно быть таким:
```
$ ls -lhi
total 160K
5388833 -rw-r--r-- 4 carol carol 77K jun 17 17:25 receitas.txt
5388833 -rw-r--r-- 4 carol carol  0K jun 17 17:25 recipes.txt
5388837 lrwxrwxrwx 1 carol carol  12 jun 17 17:25 rezepte.txt -> receitas.txt
```
Помните, что в качестве жесткой ссылки `receitas.txt` указывает на тот же индекс, который назначен `recipes.txt`. Что произойдет с мягкой ссылкой `rezepte.txt`, если удалить файл `receitas.txt`? Почему?

2. Представьте, что у вас есть флэш-накопитель, подключенный к вашей системе и смонтированный на `/media/youruser/FlashA`. Вы хотите создать ссылку с именем `schematics.pdf` в своем домашнем каталоге, указывающую на файл `esquema.pdf` в корне флеш-накопителя.
```
$ ln /media/youruser/FlashA/esquema.pdf ~/schematics.pdf
```
Что случилось бы? Почему?
3. Рассмотрим следующий вывод `ls -lah`:
```
$ ls -lah
total 3,1M
drwxr-xr-x 2 carol carol 4,0K jun 17 17:27 .
drwxr-xr-x 5 carol carol 4,0K jun 17 17:29 ..
-rw-rw-r-- 1 carol carol 2,8M jun 17 15:45 compressed.zip
-rw-r--r-- 4 carol carol  77K jun 17 17:25 document.txt
-rw-rw-r-- 1 carol carol 216K jun 17 17:25 image.png
-rw-r--r-- 4 carol carol  77K jun 17 17:25 text.txt
```
* Сколько ссылок указывают на файл `document.txt`?
* Это мягкие или жесткие ссылки?
* Какой параметр следует передать команде `ls`, чтобы узнать, какой индексный дескриптор занимает каждый файл?
4. Представьте, что у вас есть в каталоге `~/Documents` файл с именем `clients.txt`, содержащий имена некоторых клиентов, и каталог с именем `somedir`. Внутри него есть другой файл с разными именами также с именем `clients.txt`. Чтобы воспроизвести эту структуру, используйте следующие команды.
```
$ cd ~/Documents
$ echo "John, Michael, Bob" > clients.txt
$ mkdir somedir
$ echo "Bill, Luke, Karl" > somedir/clients.txt
```
Затем вы создаете ссылку внутри `somedir` с именем `partners.txt`, указывающую на этот файл, с помощью команд:
```
$ cd somedir/
$ ln -s clients.txt partners.txt
```
Итак, структура каталогов такова:
```
Documents
|-- clients.txt
`-- somedir
    |-- clients.txt
    `-- partners.txt -> clients.txt
```
Теперь вы переместите файл `partners.txt` из `somedir` в `~/Documents` и перечислите его содержимое.
```
$ cd ~/Documents/
$ mv somedir/partners.txt .
$ less partners.txt
```
Ссылка по-прежнему будет работать? Если да, то в каком файле будет указано его содержимое? Почему?
5. Рассмотрим следующие файлы:
```
-rw-r--r-- 1 carol carol 19 Jun 24 11:12 clients.txt
lrwxrwxrwx 1 carol carol 11 Jun 24 11:13 partners.txt -> clients.txt
```
Какие разрешения на доступ к файлу `partners.txt`? Почему?


# Резюме

На этом уроке вы узнали:
* Где хранятся временные файлы.
* Какое специальное разрешение на них распространяется.
* Какие есть ссылки.
* Разница между символическими и жесткими ссылками.
* How to create links.
* Как переместить, переименовать или удалить эти ссылки.

В этом уроке обсуждались следующие команды:
* `ln`: команда «ссылка». Сама по себе эта команда создает жесткую ссылку. С помощью переключателя `-s` можно создать символическую или программную ссылку. Помните, что жесткие ссылки могут находиться только в одном разделе и файловой системе, а символические ссылки могут перемещаться по разделам и файловым системам (даже к сетевому хранилищу).
* Параметр `-i` для `ls`, который позволяет просматривать номер inode для файла.

# Ответы на упражнения для закрепления



# Ответы на упражнения для размышления


