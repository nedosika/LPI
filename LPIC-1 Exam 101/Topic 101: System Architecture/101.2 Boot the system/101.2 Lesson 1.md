# 101.2 Урок 1

| Сертификат:   | LPIC-1                                      |
|:--------------|:--------------------------------------------|
| Версия:       | 5.0                                         |
| Тема:         | 101 Архитектура системы                     |                           
| Цель:         | 101.2 Загрузка системы                      |
| Урок:         | 1 из 1                                      |


## Введение

Для управления машиной, основной компонент операционной системы - ядро, должно быть загружено программой, называемой загрузчиком, которая сама загружается с помощью предустановленной прошивки, такой как BIOS или UEFI. Загрузчик можно настроить для передачи параметров ядру, например, какой раздел содержит корневую файловую систему или в каком режиме должна выполняться операционная система. После загрузки ядро продолжает процесс загрузки, идентифицируя и настраивая оборудование. Наконец, ядро вызывает утилиту, отвечающую за запуск системных служб и управление ими.

>В некоторых дистрибутивах Linux для команд, выполняемых в этом уроке, могут потребоваться привилегии root.


## BIOS или UEFI

Процедуры, выполняемые машинами x86 для запуска загрузчика, различны, и используют они BIOS или UEFI. BIOS, сокращение от Basic Input/Output System, - это программа, хранящаяся в микросхеме энергонезависимой памяти, прикрепленной к материнской плате, и выполняется каждый раз при включении компьютера. Этот тип программы называется прошивкой, и ее место хранения отдельно от других запоминающих устройств, которые может иметь система. BIOS предполагает, что первые 440 байтов в первом запоминающем устройстве - следуя порядку, определенному в служебной программе настройки BIOS - являются первым этапом загрузчика(также называемого *начальным загрузчиком*). Первые 512 байтов запоминающего устройства называются MBR(*Master Boot Record*) запоминающих устройств, использующих стандартную схему разделов DOS, и, в дополнение к первому этапу загрузчика, содержат таблицу разделов. Если MBR не содержит правильных данных, система не сможет загрузиться, если не будет использован альтернативный метод. 

Говоря вцелом, предварительные шаги для загрузки системы, оснащенной BIOS, следующие: 
* Процесс POST(*power-on self-test*) выполняется для выявления простых отказов оборудования сразу после включения машины.
* BIOS активирует основные компоненты для загрузки системы, такие как видеовыход, клавиатура и носители. 
* BIOS загружает первый уровень загрузчика из MBR (первые 440 байтов первого устройства, как определено в утилите конфигурации BIOS). 
* Первый уровень загрузчика вызывает второй уровень загрузчика, отвечающий за представление параметров загрузки и загрузку ядра. 

UEFI, сокращение от *Unified Extensible Firmware Interface*, отличается от BIOS в некоторых ключевых моментах. Как и BIOS, UEFI также является прошивкой, но он может идентифицировать разделы и читать большинство файловых системы, обнаруженные на них. UEFI не полагается на MBR, принимая во внимание только настройки, хранящиеся в его энергонезависимой памяти(*NVRAM*), подключенной к материнской плате. Эти значения указывают на расположение программ, совместимых с UEFI, называемых приложениями EFI, которые будут выполняться автоматически или вызываться из меню загрузки. Приложения EFI могут быть загрузчиками, селекторами операционной системы, инструментами для диагностики и восстановления системы и т.д. Они должны находиться в обычном разделе устройства хранения и в совместимой файловой системе. Стандартные совместимые файловые системы - FAT12, FAT16 и FAT32 для блочных устройств и ISO-9660 для оптических носителей. Такой подход позволяет реализовать гораздо более сложные инструменты, чем те, которые возможны в BIOS. 

Раздел, содержащий приложения EFI, называется *системным разделом EFI* или просто ESP. Этот раздел не должен использоваться совместно с другими системными файловыми системами, такими как корневая файловая система или файловые системы пользовательских данных. Каталог EFI в разделе ESP содержит приложения, на которые указывают записи, сохраненные в NVRAM. 

В общем, шаги перед загрузкой операционной системы в системе с UEFI: 
* Процесс POST(*самотестирование при включении*) выполняется для выявления простых отказов оборудования сразу после включения машины. 
* UEFI активирует основные компоненты для загрузки системы, такие как видеовыход, клавиатура и носители. 
* Прошивка UEFI считывает настройки, хранящиеся в NVRAM, для выполнения предварительно определенного приложения EFI, хранящегося в файловой системе раздела ESP. Обычно предопределенное приложение EFI является загрузчиком. 
* Если предварительно определенное приложение EFI является загрузчиком, оно загрузит ядро для запуска операционной системы. 

Стандарт UEFI также поддерживает функцию *Secure Boot*, которая позволяет выполнять только подписанные приложения EFI, то есть приложения EFI, авторизованные производителем оборудования. Эта функция увеличивает защиту от вредоносного программного обеспечения, но может затруднить установку операционных систем, на которые не распространяется гарантия производителя.


## Загрузчик

Самый популярный загрузчик для Linux на архитектуре x86 - это GRUB(*Grand Unified Bootloader*). Как только он вызывается BIOS или UEFI, GRUB отображает список операционных систем, доступных для загрузки. Иногда список не появляется автоматически, но его можно вызвать, нажав <kbd>Shift</kbd>, когда BIOS вызывает GRUB. В системах UEFI вместо этого следует использовать клавишу <kbd>Esc</kbd>. 

В меню GRUB можно выбрать, какое из установленных ядер должно быть загружено, и передать ему новые параметры. Большинство параметров ядра следуют шаблону `option=value`. Некоторые из наиболее полезных параметров ядра: 

* `acpi`   
Включает/отключает поддержку ACPI. `acpi=off` отключит поддержку ACPI. 
* `init`  
Устанавливает альтернативный системный инициатор. Например, `init=/bin/bash` установит оболочку Bash в качестве инициатора. Это означает, что сеанс оболочки начнется сразу после процесса загрузки ядра. 
* `systemd.unit`  
Устанавливает цель `systemd` для активации. Например, `systemd.unit=graphical.target`. Systemd также принимает числовые уровни запуска, определенные для *SysV*. Например, чтобы активировать уровень выполнения 1, необходимо только включить цифру `1` или букву `S`(сокращение от «single») в качестве параметра ядра. 
* `mem`  
Устанавливает объем доступной оперативной памяти для системы. Этот параметр полезен для виртуальных машин, чтобы ограничить объем оперативной памяти, доступной каждому гостю. Использование `mem=512M` ограничивает объем оперативной памяти, доступной для конкретной гостевой системы, до 512 мегабайт. 
* `maxcpus`  
Ограничивает количество процессоров(или ядер процессора), видимых системе в симметричных многопроцессорных машинах. Это также полезно для виртуальных машин. Значение 0 отключает поддержку многопроцессорных машин и имеет тот же эффект, что и параметр ядра `nosmp`. Параметр `maxcpus=2` ограничивает количество процессоров, доступных операционной системе, до двух. 
* `quiet`  
Скрывает большинство загрузочных сообщений. 
* `vga`  
Выбирает режим видео. Параметр `vga=ask` покажет список доступных режимов на выбор. 
* `root`  
Устанавливает корневой раздел, отличный от предварительно настроенного в загрузчике. Например, `root=/dev/sda3`.
* `rootflags`  
Параметры монтирования для корневой файловой системы. 
* `ro`
Делает первоначальное монтирование корневой файловой системы доступным только для чтения. 
* `rw`  
Разрешает запись в корневую файловую систему во время первоначального монтирования. 

Изменение параметров ядра обычно не требуется, но может быть полезно для обнаружения и решения проблем, связанных с операционной системой. Параметры ядра должны быть добавлены в файл `/etc/default/grub` в строке `GRUB_CMDLINE_LINUX`, чтобы сделать их постоянными при перезагрузках. Новый файл конфигурации для загрузчика должен создаваться каждый раз при изменении `/etc/default/grub`, что выполняется командой `grub-mkconfig -o /boot/grub/grub.cfg`. После запуска операционной системы параметры ядра, используемые для загрузки текущего сеанса, доступны для чтения в файле `/proc/cmdline`.

>Настройка GRUB будет обсуждаться далее в следующем уроке.


## Система инициализации

Помимо ядра, операционная система зависит от других компонентов, которые предоставляют ожидаемые функции. Многие из этих компонентов загружаются в процессе инициализации системы, от простых сценариев оболочки до более сложных служебных программ. Сценарии часто используются для выполнения краткосрочных задач, которые будут выполняться и завершаться в процессе инициализации системы. Службы, также известные как демоны, могут быть активны все время, поскольку они могут нести ответственность за внутренние аспекты операционной системы. 

Разнообразие способов, которыми сценарии запуска и демоны с самыми разными характеристиками могут быть встроены в дистрибутив Linux, огромно, и этот факт исторически препятствовал разработке единого решения, отвечающего ожиданиям сопровождающих и пользователей всех дистрибутивов Linux. Однако любой инструмент, выбранный разработчиками дистрибутива для выполнения этой функции, по крайней мере сможет запускать, останавливать и перезапускать системные службы. Эти действия часто выполняются самой системой, например, после обновления программного обеспечения, но системному администратору почти всегда необходимо вручную перезапускать службу после внесения изменений в ее файл конфигурации. 

Системному администратору также удобно иметь возможность активировать определенный набор демонов в зависимости от обстоятельств. Например, должна быть возможность запускать минимальный набор служб для выполнения задач обслуживания системы.

>Строго говоря, операционная система - это просто ядро и его компоненты, которые управляют оборудованием и всеми процессами. Однако обычно термин «операционная система» используется более свободно для обозначения целой группы отдельных программ, составляющих программную среду, в которой пользователь может выполнять основные вычислительные задачи.

Инициализация операционной системы начинается, когда загрузчик загружает ядро ​​в ОЗУ. Затем ядро ​​возьмет на себя ответственность за ЦП и начнет обнаруживать и настраивать фундаментальные аспекты операционной системы, такие как базовая конфигурация оборудования и адресация памяти. Затем ядро ​​откроет initramfs (начальная файловая система RAM). Initramfs - это архив, содержащий файловую систему, используемую в качестве временной корневой файловой системы во время процесса загрузки. Основная цель файла initramfs - предоставить необходимые модули, чтобы ядро ​​могло получить доступ к «настоящей» корневой файловой системе операционной системы. Как только будет доступна корневая файловая система, ядро ​​смонтирует все файловые системы, настроенные в / etc / fstab, а затем выполнит первую программу - утилиту с именем init. Программа init отвечает за запуск всех сценариев инициализации и системных демонов. Существуют различные реализации таких системных инициаторов, помимо традиционного init, такие как systemd и Upstart. После загрузки программы init файл initramfs удаляется из ОЗУ. Стандарт SysV Менеджер служб, основанный на стандарте SysVinit, контролирует, какие демоны и ресурсы будут доступны, используя концепцию уровней выполнения. Уровни выполнения пронумерованы от 0 до 6 и разработаны разработчиками дистрибутива для выполнения определенных задач. Единственные определения уровней выполнения, общие для всех дистрибутивов, - это уровни выполнения 0, 1 и 6. systemd systemd - это современный менеджер систем и служб с уровнем совместимости для команд и уровней запуска SysV. systemd имеет параллельную структуру, использует сокеты и D-Bus для активации служб, выполнения демона по требованию, мониторинга процессов с помощью cgroups, поддержки моментальных снимков, восстановления системного сеанса, управления точкой монтирования и управления службами на основе зависимостей. В последние годы большинство основных дистрибутивов Linux постепенно приняли systemd в качестве системного менеджера по умолчанию. Выскочка Как и systemd, Upstart заменяет init. Цель Upstart - ускорить процесс загрузки за счет распараллеливания процесса загрузки системных служб. Upstart использовался в дистрибутивах на основе Ubuntu в прошлых выпусках, но сегодня уступил место systemd.
