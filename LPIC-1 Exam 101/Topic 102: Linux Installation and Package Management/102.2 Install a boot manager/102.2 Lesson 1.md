# 102.2 Урок 1

| **Сертификат:** | LPIC-1                                    |
|:----------------|:------------------------------------------|
| **Версия:**     | 5.0                                       |
| **Тема:**       | 102 Установка Linux и управление пакетами |
| **Цель:**       | 102.2 Установка диспетчера загрузки       |
| **Урок:**       | 1 из 1                                    |


## Введение

Когда компьютер включается, первое запускаемое программное обеспечение - это загрузчик. Это фрагмент кода, единственная цель которого - загрузить ядро операционной системы и передать ему управление. Ядро загрузит необходимые драйвера, инициализирует оборудование, а затем загрузит остальную часть операционной системы. 

GRUB - это загрузчик, используемый в большинстве дистрибутивов Linux. Он может загружать ядро Linux или другие операционные системы, такие как Windows, и может обрабатывать несколько образов и параметров ядра как отдельные пункты меню. Выбор ядра при загрузке осуществляется через интерфейс, управляемый клавиатурой, и есть интерфейс командной строки для редактирования опций и параметров загрузки. 

Большинство дистрибутивов Linux устанавливают и настраивают GRUB (фактически, GRUB 2) автоматически, поэтому обычному пользователю не нужно об этом думать. Однако системному администратору жизненно важно знать, как управлять процессом загрузки, чтобы вы могли восстановить систему после сбоя загрузки, например, после неудачного обновления ядра. В этом уроке вы узнаете, как установить, настроить и взаимодействовать с GRUB.


## GRUB Legacy или GRUB2

Первоначальная версия GRUB (Grand Unified Bootloader), теперь известная как GRUB Legacy, была разработана в 1995 году как часть проекта GNU Hurd, а затем была принята в качестве загрузчика по умолчанию для многих дистрибутивов Linux, заменив более ранние альтернативы, такие как LILO. 

GRUB2 - это полностью переписанный GRUB с целью сделать его чище, безопаснее, надежнее и мощнее. Среди многих преимуществ перед GRUB Legacy - гораздо более гибкий файл конфигурации (с большим количеством команд и условных операторов, похожий на язык сценариев), более модульный дизайн и лучшая локализация/интернационализация. 

Также есть поддержка тем и графических меню загрузки с экранами-заставками, возможность загружать ISO-образы LiveCD непосредственно с жесткого диска, улучшенная поддержка архитектур, отличных от x86, универсальная поддержка UUID (упрощающая идентификацию дисков и разделов) и многое другое. 

GRUB Legacy больше не находится в активной разработке (последний выпуск был 0.97 в 2005 году), и сегодня большинство основных дистрибутивов Linux устанавливают GRUB2 в качестве загрузчика по умолчанию. Однако вы все еще можете найти системы, использующие GRUB Legacy, поэтому важно знать, как его использовать и чем он отличается от GRUB2.


## Где находится загрузчик?

Исторически жесткие диски в IBM PC-совместимых системах были разделены с использованием схемы разделения MBR, созданной в 1982 году для IBM PC-DOS (MS-DOS) 2.0. 

В этой схеме первый 512-байтовый сектор диска называется главной загрузочной записью и содержит таблицу, описывающую разделы на диске (таблица разделов), а также код начальной загрузки, называемый загрузчиком. 

Когда компьютер включается, этот минимальный(из-за ограничений размера) код загрузчика загружается, выполняется и передает управление вторичному загрузчику на диске, обычно расположенному в пространстве 32КБ между MBR и первым разделом, который в свою очередь загрузит операционную систему. 

На диске с разделами MBR загрузочный код для GRUB устанавливается в MBR. Он загружает и передает управление образу «ядра», установленному между MBR и первым разделом. С этого момента GRUB может загружать с диска остальные необходимые ресурсы (меню, файлы конфигурации и дополнительные модули). 

Однако MBR имеет ограничения на количество разделов (первоначально максимум 4 основных раздела, позже максимум 3 основных раздела с 1 расширенным разделом, разделенным на несколько логических разделов) и максимальный размер диска в 2ТБ. Чтобы преодолеть эти ограничения, была создана новая схема разбиения под названием GPT(*таблица разделов GUID*), часть стандарта UEFI (*Unified Extensible Firmware Interface*). 

Диски с разделами GPT можно использовать как с компьютерами с традиционным PC BIOS, так и с прошивкой UEFI. На машинах с BIOS вторая часть GRUB хранится в специальном загрузочном разделе BIOS. 

В системах с прошивкой UEFI GRUB загружается прошивкой из файлов `grubia32.efi` (для 32-битных систем) или `grubx64.efi` (для 64-битных систем) из раздела, называемого ESP (*системный раздел EFI*).


## Раздел `/boot`

В Linux файлы, необходимые для процесса загрузки, обычно хранятся в загрузочном разделе, монтируются в корневой файловой системе и обычно называются `/boot`. 

В текущих системах загрузочный раздел не требуется, так как загрузчики, такие как GRUB, обычно могут монтировать корневую файловую систему и искать необходимые файлы внутри каталога `/boot`, но это хорошая практика, поскольку они разделяют файлы, необходимые для процесса загрузки от остальной файловой системы. 

Этот раздел обычно является первым на диске. Это связано с тем, что исходный BIOS IBM PC адресовал диски с использованием *цилиндров*, *головок* и *секторов* (CHS) с максимальным размером 1024 цилиндров, 256 головок и 63 секторов, в результате чего максимальный размер диска составлял 528МБ (504 МБ в MS-DOS). Это означает, что все, что выходит за рамки этой отметки, будет недоступно, если не будет использована другая схема адресации диска (например, LBA, *логическая адресация блоков*). 

Таким образом, для максимальной совместимости раздел `/boot` обычно расположен в начале диска и заканчивается перед 1024 цилиндром (528МБ), что гарантирует, что машина всегда сможет загрузить ядро. Рекомендуемый размер этого раздела на текущей машине - 300 МБ. 

Другими причинами для отдельного раздела `/boot` являются шифрование и сжатие, поскольку некоторые методы могут еще не поддерживаться GRUB2, или если вам нужно отформатировать системный корневой раздел (`/`) с использованием неподдерживаемой файловой системы.


### Содержимое загрузочного раздела

Содержимое раздела `/boot` может различаться в зависимости от архитектуры системы или используемого загрузчика, но в системе на базе x86 вы обычно найдете файлы, указанные ниже. Большинство из них имеют суффикс `-VERSION`, где `-VERSION` - это версия соответствующего ядра Linux. Так, например, файл конфигурации для ядра Linux версии `4.15.0-65-generic` будет называться `config-4.15.0-65-generic`. 

Файл конфигурации  
Этот файл, обычно называемый `config-VERSION` (см. Пример выше), хранит параметры конфигурации для ядра Linux. Этот файл создается автоматически при компиляции или установке нового ядра и не должен напрямую изменяться пользователем. 

Системная карта  
Этот файл представляет собой таблицу поиска, сопоставляющую имена символов (например, переменных или функций) с их соответствующей позицией в памяти. Это полезно при отладке системного сбоя, известного как паника ядра, поскольку позволяет пользователю узнать, какая переменная или функция вызывалась, когда произошел сбой. Как и у файла конфигурации, имя обычно `System.map-VERSION`(например, `System.map-4.15.0-65-generic`). 

Ядро Linux  
Это собственно ядро операционной системы. Обычно это имя `vmlinux-VERSION`(например, `vmlinux-4.15.0-65-generic`). Вы также можете найти имя `vmlinuz` вместо `vmlinux`, буква `z` в конце означает, что файл был сжат. 

Начальный RAM-диск  
Обычно это называется `initrd.img-VERSION` и содержит минимальную корневую файловую систему, загруженную на RAM-диск, содержащую утилиты и модули ядра, необходимые для того, чтобы ядро могло смонтировать настоящую корневую файловую систему. Файлы, связанные с загрузчиком В системах с установленным GRUB они обычно находятся в `/boot/grub` и включают файл конфигурации GRUB(`/boot/grub/grub.cfg` для GRUB2 или `/boot/grub/menu.lst` в случае GRUB Legacy), модули (в `/boot/grub/i386-pc`), файлы перевода (в `/boot/grub/locale`) и шрифты (в `/boot/grub/fonts`).


## GRUB2


### Установка GRUB2

GRUB2 можно установить с помощью утилиты `grub-install`. Если у вас не загружаемая система, вам нужно будет загрузиться с Live CD или аварийного диска, выяснить, какой раздел является загрузочным для вашей системы, смонтировать его и затем запустить утилиту.

> Команды ниже предполагают, что вы вошли в систему как root. Если нет, то сначала запустите `sudo su` - чтобы «стать» root. По завершении введите `exit`, чтобы выйти из системы и вернуться к обычному пользователю.

Первый диск в системе обычно является *загрузочным устройством*, и вам может потребоваться узнать, есть ли на диске *загрузочный раздел*. Это можно сделать с помощью утилиты `fdisk`. Чтобы перечислить все разделы на первом диске вашей машины, используйте:
```console
# fdisk -l /dev/sda
Disk /dev/sda: 111,8 GiB, 120034123776 bytes, 234441648 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x97f8fef5

Device     Boot    Start       End   Sectors   Size Id Type
/dev/sda1  *        2048   2000895   1998848   976M 83 Linux
/dev/sda2        2002942 234440703 232437762 110,9G  5 Extended
/dev/sda5        2002944  18008063  16005120   7,6G 82 Linux swap / Solaris
/dev/sda6       18010112 234440703 216430592 103,2G 83 Linux
```
Загрузочный раздел помечен `*` под столбцом загрузки. В приведенном выше примере это `/dev/sda1`. Теперь создайте временный каталог в `/mnt` и смонтируйте раздел в нем:
```console
# mkdir /mnt/tmp
# mount /dev/sda1 /mnt/tmp
```
Затем запустите `grub-install`, указав ему на загрузочное устройство (а не на раздел) и каталог, в котором смонтирован загрузочный раздел. Если в вашей системе есть выделенный загрузочный раздел, используйте следующую команду:
```console
# grub-install --boot-directory=/mnt/tmp /dev/sda1
```
Если вы выполняете установку в системе, в которой нет загрузочного раздела, а есть только каталог `/boot` в корневой файловой системе, укажите на него `grub-install`. Итак, команда такая:
```console
# grub-install --boot-directory=/boot /dev/sda1
```


### Настройка GRUB2

Файл конфигурации по умолчанию для GRUB2 - `/boot/grub/grub.cfg`. Этот файл создается автоматически, и ручное редактирование не рекомендуется. Чтобы внести изменения в конфигурацию GRUB, вам необходимо отредактировать файл `/etc/default/grub`, а затем запустить утилиту `update-grub` для создания совместимого файла.

>`update-grub` обычно является ярлыком для `grub-mkconfig -o /boot/grub/grub.cfg`, поэтому они дают те же результаты.

В файле `/etc/default/grub` есть несколько параметров, которые управляют поведением GRUB2, например, ядро по умолчанию для загрузки, тайм-аут, дополнительные параметры командной строки и т. д. Наиболее важными из них являются: 

* `GRUB_DEFAULT =*  
Пункт меню по умолчанию для загрузки. Это может быть числовое значение (например, `0`, `1` и т. д.), Имя пункта меню (например, `debian`) или сохраненное, которое используется вместе с `GRUB_SAVEDEFAULT =`, как описано ниже. Имейте в виду, что пункты меню начинаются с нуля, поэтому первая запись меню - `0`, вторая - `1` и т. д.

* `GRUB_SAVEDEFAULT =`  
Если для этого параметра установлено значение `true`, а для параметра `GRUB_DEFAULT =` установлено значение `saved`, то параметр загрузки по умолчанию всегда будет последним, выбранным в меню загрузки. 

* `GRUB_TIMEOUT =`  
Тайм-аут в секундах до выбора пункта меню по умолчанию. Если установлено значение `0`, система загрузит запись по умолчанию без отображения меню. Если установлено значение `-1`, система будет ждать, пока пользователь выберет вариант, независимо от того, сколько времени это займет. 

* `GRUB_CMDLINE_LINUX =`  
В нем перечислены параметры командной строки, которые будут добавлены в записи для ядра Linux. 

* `GRUB_CMDLINE_LINUX_DEFAULT =`  
По умолчанию для каждого ядра Linux создаются две записи меню, одна с параметрами по умолчанию и одна запись для восстановления. С помощью этой опции вы можете добавить дополнительные параметры, которые будут добавлены только к записи по умолчанию. 

* `GRUB_ENABLE_CRYPTODISK =`  
Если установлено значение `y`, такие команды, как `grub-mkconfig`, `update-grub` и `grub-install`, будут искать зашифрованные диски и добавлять команды, необходимые для доступа к ним во время загрузки. Это отключает автоматическую загрузку (`GRUB_TIMEOUT =` с любым значением, отличным от `-1`), потому что для дешифрования дисков до того, как к ним можно будет получить доступ, требуется кодовая фраза.


### Управление пунктами меню

При запуске `update-grub` GRUB2 просканирует на компьютере ядра и операционные системы и сгенерирует соответствующие записи меню в файле `/boot/grub/grub.cfg`. Новые записи можно вручную добавлять в файлы сценариев в каталоге `/etc/grub.d`. 

Эти файлы должны быть исполняемыми и обрабатываются `update-grub` в числовом порядке. Следовательно, `05_debian_theme` обрабатывается до `10_linux` и так далее. Пользовательские пункты меню обычно добавляются в файл `40_custom`. Базовый синтаксис для входа в меню показан ниже:
```console
menuentry "Default OS" {
    set root=(hd0,1)
    linux /vmlinuz root=/dev/sda1 ro quiet splash
    initrd /initrd.img
}
```
Первая строка всегда начинается с `menuentry` и заканчивается `{`. Текст в кавычках будет отображаться как метка входа в меню загрузки GRUB2. 

Параметр `set root` определяет диск и раздел, в котором расположена корневая файловая система операционной системы. Обратите внимание, что в GRUB2 диски нумеруются с нуля, поэтому `hd0` - это первый диск (`sda` в Linux), `hd1` - второй и так далее. Однако разделы нумеруются, начиная с единицы. В приведенном выше примере корневая файловая система расположена на первом диске (`hd0`), первом разделе (`,1`) или `sda1`. 

Вместо прямого указания устройства и раздела вы также можете настроить GRUB2 для поиска файловой системы с определенной меткой или UUID (`универсальный уникальный идентификатор`). Для этого используйте параметр `search --set = root`, за которым следует параметр `--label` и метка файловой системы для поиска, или `--fs-uuid`, за которым следует UUID файловой системы. 

Вы можете найти UUID файловой системы с помощью следующей команды:
```console
$ ls -l /dev/disk/by-uuid/
total 0
lrwxrwxrwx 1 root root 10 nov  4 08:40 3e0b34e2-949c-43f2-90b0-25454ac1595d -> ../../sda5
lrwxrwxrwx 1 root root 10 nov  4 08:40 428e35ee-5ad5-4dcb-adca-539aba6c2d84 -> ../../sda6
lrwxrwxrwx 1 root root 10 nov  5 19:10 56C11DCC5D2E1334 -> ../../sdb1
lrwxrwxrwx 1 root root 10 nov  4 08:40 ae71b214-0aec-48e8-80b2-090b6986b625 -> ../../sda1
```
В приведенном выше примере UUID для `/dev/sda1` - `ae71b214-0aec-48e8-80b2-090b6986b625`. Если вы хотите установить его в качестве корневого устройства для GRUB2, команда будет выглядеть так: `search --set = root --fs-uuid ae71b214-0aec-48e8-80b2-090b6986b625`. 

При использовании команды поиска обычно добавляют параметр `--no-floppy`, чтобы GRUB не тратил время на поиск на дискетах. 

Строка `linux` указывает, где находится ядро операционной системы (в данном случае файл `vmlinuz` в корне файловой системы). После этого вы можете передать ядру параметры командной строки. 

В приведенном выше примере мы указали корневой раздел (`root=/dev/sda1`) и передали три параметра ядра: корневой раздел должен быть смонтирован только для чтения (`ro`), большинство сообщений журнала должно быть отключено (`quiet`) и заставка экрана должен быть показана (`splash`). 

Строка `initrd` указывает, где находится исходный RAM-диск. В приведенном выше примере это файл `initrd.img`, расположенный в корне файловой системы.

>Большинство дистрибутивов Linux фактически не помещают ядро и initrd в корневой каталог корневой файловой системы. Вместо этого это ссылки на фактические файлы внутри каталога или раздела `/boot`.

Последняя строка пункта меню должна содержать только символ `}`.


### Взаимодействие с GRUB2

При загрузке системы с GRUB2 вы увидите меню параметров. Используйте клавиши со стрелками, чтобы выбрать параметр, и <kbd>Enter</kbd>, чтобы подтвердить и загрузить выбранную запись.

>Если вы видите только обратный отсчет, но не меню, нажмите <kbd>Shift</kbd>, чтобы открыть меню.

Чтобы отредактировать параметр, выберите его с помощью клавиш со стрелками и нажмите <kbd>E</kbd>. Откроется окно редактора с содержимым элемента меню, связанного с этим параметром, как определено в `/boot/grub/grub.cfg`.

После редактирования параметра нажмите <kbd>Ctrl</kbd>+<kbd>X</kbd> или <kbd>F10</kbd> для загрузки или <kbd>Esc</kbd> для возврата в меню. 

Чтобы войти в оболочку GRUB2, нажмите <kbd>C</kbd> на экране меню (или <kbd>Ctrl</kbd>+<kbd>C</kbd>) в окне редактирования). Вы увидите такую командную строку: `grub>` 

Введите `help`, чтобы увидеть список всех доступных команд, или нажмите <kbd>Esc</kbd>, чтобы выйти из оболочки и вернуться к экрану меню.

>Помните, что это меню не появится, если для `GRUB_TIMEOUT` установлено значение `0` в `/etc/default/grub`


### Загрузка из оболочки GRUB2

Вы можете использовать оболочку GRUB2 для загрузки системы в случае, если неправильная конфигурация в пункте меню приведет к сбою. 

Первое, что вам нужно сделать, это выяснить, где находится загрузочный раздел. Вы можете сделать это с помощью команды `ls`, которая покажет вам список разделов и дисков, обнаруженных GRUB2.
```console
grub> ls
(proc) (hd0) (hd0,msdos1)
```
В приведенном выше примере все просто. Есть только один диск (`hd0`) с одним разделом на нем: (`hd0,msdos1`). 

Перечисленные диски и разделы в вашей системе будут другими. В нашем примере первый раздел `hd0` называется `msdos1`, потому что диск был разбит на разделы с использованием схемы разделения MBR. Если бы он был разделен с помощью GPT, имя было бы `gpt1`. 

Для загрузки Linux нам понадобится ядро и начальный RAM-диск (`initrd`). Проверим содержимое (`hd0,msdos1`):
```console
grub> ls (hd0,msdos1)/
lost+found/ swapfile etc/ media/ bin/ boot/ dev/ home/ lib/ lib64/ mnt/ opt/ proc/ root/ run/ sbin/ srv/ sys/ tmp/ usr/ var/ initrd.img initrd.img.old vmlinuz cdrom/
```
Вы можете добавить параметр `-l` к `ls`, чтобы получить длинный список, аналогичный тому, который вы получили бы в терминале Linux. Используйте <kbd>Tab</kbd> для автозаполнения имен дисков, разделов и имен файлов. 

Обратите внимание, что у нас есть образы ядра (`vmlinuz`) и initrd (`initrd.img`) прямо в корневом каталоге. Если нет, мы можем проверить содержимое `/boot` с помощью `list` (`hd0,msdos1`) `/boot/`. 

Теперь установите загрузочный раздел:
```console
grub> set root=(hd0,msdos1)
```
Загрузите ядро Linux с помощью команды `linux`, за которой следует путь к ядру и параметр `root=`, чтобы указать ядру, где находится корневая файловая система для операционной системы.
```console
grub> linux /vmlinuz root=/dev/sda1
```
Загрузите начальный RAM-диск с помощью `initrd`, после чего укажите полный путь к файлу `initrd.img`:
```console
grub> initrd /initrd.img
```
Теперь загрузите систему с помощью `boot`.


### Загрузка из Rescue Shell

В случае сбоя загрузки GRUB2 может загрузить Rescue Shell, упрощенную версию оболочки, о которой мы упоминали ранее. Вы узнаете это по командной строке, которая отображается как `grub rescue>`. 

Процесс загрузки системы из этой оболочки почти такой же, как показано ранее. Однако вам нужно будет загрузить несколько модулей GRUB2, чтобы все заработало. 

После определения того, какой раздел является загрузочным (с помощью `ls`, как показано ранее), используйте команду `set prefix=`, за которой следует полный путь к каталогу, содержащему файлы GRUB2. Обычно `/boot/grub`. В нашем примере:
```console
grub rescue> insmod normal
grub rescue> insmod linux
```
Затем установите загрузочный раздел с помощью `set root=`, как указано ранее, загрузите ядро Linux (с Linux), начальный RAM-диск (`initrd`) и попробуйте загрузиться при помощи `boot`.


## GRUB Legacy

### Установка GRUB Legacy из запущенной системы

Чтобы установить GRUB Legacy на диск из работающей системы, мы воспользуемся утилитой `grub-install`. Основная команда - `grub-install DEVICE`, где `DEVICE` - это диск, на который вы хотите установить GRUB Legacy. Примером может быть `/dev/sda`.
```console
# grub-install /dev/sda
```
Обратите внимание, что вам нужно указать `устройство`, на котором будет установлен GRUB Legacy, например `/dev/sda/`, а `не раздел`, как в `/dev/sda1`. 

По умолчанию GRUB скопирует необходимые файлы в каталог `/boot` на указанном устройстве. Если вы хотите скопировать их в другой каталог, используйте параметр `--boot-directory=`, за которым следует полный путь к тому месту, куда файлы должны быть скопированы.


### Установка GRUB Legacy из оболочки GRUB

Если вы не можете загрузить систему по какой-либо причине и вам необходимо переустановить GRUB Legacy, вы можете сделать это из оболочки GRUB на загрузочном диске GRUB Legacy. 

В оболочке GRUB (нажмите `c` в меню загрузки, чтобы перейти к приглашению `grub>`), первым делом нужно установить загрузочное устройство, которое содержит каталог `/boot`. Например, если этот каталог находится в первом разделе первого диска, команда будет выглядеть так:
```console
grub> root (hd0,0)
```
Если вы не знаете, какое устройство содержит каталог `/boot`, вы можете попросить GRUB найти его с помощью команды `find`, как показано ниже:
```console
grub> find /boot/grub/stage1
 (hd0,0)
 ```
Затем установите загрузочный раздел, как описано выше, и используйте команду установки, чтобы установить GRUB Legacy в MBR и скопировать необходимые файлы на диск:
```console
grub> setup (hd0)
```
По завершении перезагрузите систему, и она должна загрузиться нормально.


### Настройка записей и параметров меню устаревших версий GRUB

Записи и настройки меню GRUB Legacy хранятся в файле `/boot/grub/menu.lst`. Это простой текстовый файл со списком команд и параметров, который можно редактировать прямо с помощью вашего любимого текстового редактора. 

Строки, начинающиеся с символа `#`, считаются комментариями, а пустые строки игнорируются. Пункт меню содержит как минимум три команды. Первая, `title`, устанавливает заголовок операционной системы на экране меню. Вторая, `root`, сообщает GRUB Legacy, с какого устройства или раздела загружаться. 

Третья запись, `kernel`, указывает полный путь к образу ядра, который должен быть загружен при выборе соответствующей записи. Обратите внимание, что этот путь относится к устройству, указанному в корневом параметре. 

Вот простой пример:
```console
# This line is a comment
title My Linux Distribution
root (hd0,0)
kernel /vmlinuz root=/dev/hda1
```
В отличие от GRUB2, в GRUB Legacy и диски, и разделы нумеруются с нуля. Итак, команда `root (hd0,0)` установит загрузочный раздел как первый раздел (`0`) первого диска (`hd0`). 

Вы можете опустить оператор `root`, если вы укажете загрузочное устройство перед путем в команде ядра. Синтаксис такой же, поэтому:
```console
kernel (hd0,0)/vmlinuz root=dev/hda1
```
эквивалентно:
```console
root (hd0,0)
kernel /vmlinuz root=/dev/hda1
```
Оба загрузят файл `vmlinuz` из корневого каталога (`/`) первого раздела первого диска (`hd0,0`). 

Параметр `root=/dev/hda1` после команды ядра сообщает ядру Linux, какой раздел следует использовать в качестве корневой файловой системы. Это параметр ядра Linux, а не команда GRUB Legacy.

>Чтобы узнать больше о параметрах ядра, см. Https://www.kernel.org/doc/html/v4.14/admin-guide/kernel-parameters.html.

Возможно, вам потребуется указать расположение исходного образа RAM-диска для операционной системы с помощью параметра `initrd`. Полный путь к файлу можно указать, как в параметре ядра, и вы также можете указать устройство или раздел перед путем, например:
```console
# This line is a comment
title My Linux Distribution
root (hd0,0)
kernel /vmlinuz root=/dev/hda1
initrd /initrd.img
```
GRUB Legacy имеет модульную конструкцию, в которой модули (обычно хранящиеся как файлы `.mod` в `/boot/grub/i386-pc`) могут быть загружены для добавления дополнительных функций, таких как поддержка необычного оборудования, файловых систем или новых алгоритмов сжатия. 

Модули загружаются с помощью команды `module`, за которой следует полный путь к соответствующему файлу `.mod`. Имейте в виду, что, как и ядра и образы `initrd`, этот путь относится к устройству, указанному в команде `root`. 

В приведенном ниже примере загружается модуль `915resolution`, необходимый для правильной установки разрешения кадрового буфера в системах с видеочипсетами Intel серии 800 или 900.
```console
module /boot/grub/i386-pc/915resolution.mod
```


### Последовательная загрузка других операционных систем

GRUB Legacy можно использовать для загрузки неподдерживаемых операционных систем, таких как Windows, с помощью процесса, называемого *chainloading*. Сначала загружается GRUB Legacy, и при выборе соответствующей опции загружается загрузчик для желаемой системы. 

Типичная запись для последовательной загрузки Windows будет выглядеть следующим образом:
```console
# Load Windows
title Windows XP
root (hd0,1)
makeactive
chainload +1
boot
```
Давайте пройдемся по каждому параметру. Как и раньше, `root (hd0,1)` указывает устройство и раздел, где находится загрузчик для операционной системы, которую мы хотим загрузить. В этом примере второй раздел первого диска. 

* `makeactive`  
установит флаг, указывающий, что это активный раздел. Это работает только с первичными разделами DOS. 

* `chainload +1`  
сообщает GRUB загрузить первый сектор загрузочного раздела. Здесь обычно находятся загрузчики. 

* `boot`  
запустит загрузчик и загрузит соответствующую операционную систему.


## Упражнения для закрепления

1. Какое расположение по умолчанию для файла конфигурации GRUB2? 

2. Что нужно сделать, чтобы изменить настройки GRUB2? 

3. В какой файл следует добавить пользовательские пункты меню GRUB2? 

4. Где хранятся пункты меню для GRUB Legacy? 

5. Как войти в оболочку GRUB из меню GRUB2 или GRUB Legacy?


## Упражнения на размышление

1. Представьте, что пользователь настраивает GRUB Legacy для загрузки со второго раздела первого диска. Он пишет следующий пользовательский пункт меню:
```console
title My Linux Distro
root (hd0,2)
kernel /vmlinuz root=/dev/hda1
initrd /initrd.img
```
Однако система не загружается. Что не так?

2. Представьте, что у вас есть диск, идентифицированный как `/dev/sda`, с несколькими разделами. Какую команду можно использовать для определения загрузочного раздела в системе? 

3. Какую команду можно использовать для определения UUID раздела? 

4. Рассмотрим следующую запись для GRUB2
```console
menuentry "Default OS" {
    set root=(hd0,1)
    linux /vmlinuz root=/dev/sda1 ro quiet splash
    initrd /initrd.img
}
```
Измените его, чтобы система загружалась с диска с UUID `5dda0af3-c995-481a-a6f3-46dcd3b6998d`

5. Как вы можете настроить GRUB2 на ожидание 10 секунд перед загрузкой пункта меню по умолчанию? 

6. Какие команды используются для установки GRUB в первый раздел второго диска в оболочке GRUB Legacy?


## Резюме

На этом уроке мы узнали Что такое загрузчик. 

* Различия между GRUB Legacy и GRUB2. 
* Что такое загрузочный раздел и каково его содержимое. 
* Как установить GRUB Legacy и GRUB2. 
* Как настроить GRUB Legacy и GRUB2. 
* Как добавить пользовательские пункты меню в GRUB Legacy и GRUB2. 
* Как взаимодействовать с экраном меню и консолью GRUB Legacy и GRUB2. 
* Как загрузить систему из оболочки GRUB Legacy или GRUB2 или оболочки восстановления. 

В этом уроке обсуждались следующие команды:  
* `grub-install` 
* `update-grub` 
* `grub-mkconfig`


## Ответы на упражнения для закрепления

**1. Какое расположение по умолчанию для файла конфигурации GRUB2?**   
`/boot/grub/grub.cfg`

**2. Что нужно сделать, чтобы изменить настройки GRUB2?**  
Внесите изменения в файл `/etc/default/grub`, затем обновите конфигурацию с помощью `update-grub`.

**3. В какой файл следует добавить пользовательские пункты меню GRUB2?**  
`/etc/grub.d/40_custom`

**4. Где хранятся пункты меню для GRUB Legacy?**
`/boot/grub/menu.lst`

**5. Как войти в оболочку GRUB из меню GRUB2 или GRUB Legacy?**  
Нажмите `c` на экране меню.


## Ответы на упражнения для размышления

**1. Представьте, что пользователь настраивает GRUB Legacy для загрузки со второго раздела первого диска. Он пишет следующий пользовательский пункт меню:
```console
title My Linux Distro
root (hd0,2)
kernel /vmlinuz root=/dev/hda1
initrd /initrd.img
```
Однако система не загружается. Что не так?**  
Неправильный загрузочный раздел. Помните, что, в отличие от GRUB2, GRUB Legacy считает разделы с *нуля*. Итак, правильная команда для второго раздела первого диска должна быть `root (hd0,1)`.

**2. Представьте, что у вас есть диск, идентифицированный как `/dev/sda`, с несколькими разделами. Какую команду можно использовать для определения загрузочного раздела в системе?**  
Используйте `fdisk -l /dev/sda`. Загрузочный раздел будет отмечен звездочкой (`*`) в списке.

**3. Какую команду можно использовать для определения UUID раздела?**  
Используйте `ls -la /dev/disk/by-uuid/` и найдите UUID, указывающий на раздел.

**4. Рассмотрим следующую запись для GRUB2
```console
menuentry "Default OS" {
    set root=(hd0,1)
    linux /vmlinuz root=/dev/sda1 ro quiet splash
    initrd /initrd.img
}
```
Измените его, чтобы система загружалась с диска с UUID `5dda0af3-c995-481a-a6f3-46dcd3b6998d`**  
Вам нужно будет изменить оператор `set root`. Вместо того, чтобы указывать диск и раздел, заставьте grub искать раздел с желаемым UUID.
```console
menuentry "Default OS" {
    search --set=root --fs-uuid 5dda0af3-c995-481a-a6f3-46dcd3b6998d
    linux /vmlinuz root=/dev/sda1 ro quiet splash
    initrd /initrd.img
}
```

**5. Как вы можете настроить GRUB2 на ожидание 10 секунд перед загрузкой пункта меню по умолчанию?**  
Добавьте параметр `GRUB_TIMEOUT=10` в `/etc/default/grub`.

**6. Какие команды используются для установки GRUB в первый раздел второго диска в оболочке GRUB Legacy?**  
```console
grub> root (hd1,0)
grub> setup (hd1)
```
